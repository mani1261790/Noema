<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>認証・再設定</title>
  <style>
    :root {
      --bg-0: #081222;
      --bg-1: #10243b;
      --bg-2: #1a2f44;
      --text: #ebf3ff;
      --muted: #a7bdd9;
      --panel: rgba(12, 22, 39, .76);
      --border: rgba(145, 183, 227, .3);
      --accent: #57c4df;
      --accent-strong: #3cacc7;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      color: var(--text);
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      background:
        radial-gradient(circle at 12% 10%, rgba(87, 196, 223, .22), transparent 42%),
        radial-gradient(circle at 90% 7%, rgba(255, 154, 95, .15), transparent 36%),
        linear-gradient(158deg, var(--bg-0) 0%, var(--bg-1) 50%, var(--bg-2) 100%);
      padding: 16px;
    }

    .card {
      width: min(92vw, 500px);
      border-radius: 24px;
      border: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 24px 56px rgba(3,7,16,.52), inset 0 1px 0 rgba(169,208,255,.15);
      padding: 20px;
      position: relative;
    }

    .back {
      position: absolute;
      top: 12px;
      left: 12px;
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .5);
      color: var(--text);
      border-radius: 10px;
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      text-decoration: none;
      line-height: 1;
    }

    h1 {
      margin: 0 0 8px 44px;
      font-size: 28px;
      line-height: 1.15;
    }

    p {
      color: var(--muted);
      line-height: 1.75;
      margin: 0 0 12px;
      font-size: 14px;
    }

    .mode-switch {
      margin: 10px 0 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .mode-btn {
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .48);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      text-align: center;
    }

    .mode-btn[data-active="true"] {
      border-color: color-mix(in oklab, var(--accent) 64%, white);
      background: linear-gradient(145deg, rgba(87,196,223,.30), rgba(60,172,199,.22));
      color: #f8fdff;
      font-weight: 700;
    }

    label {
      display: block;
      font-size: 13px;
      margin: 10px 0 6px;
      color: var(--muted);
    }

    input {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(17, 33, 52, .66);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }

    input:focus {
      border-color: color-mix(in oklab, var(--accent) 68%, white);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 24%, transparent);
    }

    .button {
      border: 1px solid color-mix(in oklab, var(--accent) 65%, white);
      background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%);
      color: white;
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    .button-ghost {
      margin-top: 8px;
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .5);
      color: var(--text);
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      text-align: center;
    }

    a.button-ghost {
      display: block;
      text-decoration: none;
    }

    .status {
      margin-top: 10px;
      border: 1px solid transparent;
      background: transparent;
      border-radius: 14px;
      padding: 0;
      line-height: 1.65;
      opacity: 0;
      transform: translateY(-2px);
      max-height: 0;
      overflow: hidden;
      transition: opacity 160ms ease, transform 160ms ease, max-height 180ms ease, padding 160ms ease;
    }

    .status[data-state="visible"] {
      opacity: 1;
      transform: translateY(0);
      max-height: 260px;
      padding: 10px 12px;
    }

    .status[data-kind="info"] {
      border-color: color-mix(in oklab, var(--accent) 30%, var(--border));
      background: rgba(20, 40, 64, .56);
      color: color-mix(in oklab, var(--text) 86%, white);
    }

    .status[data-kind="success"] {
      border-color: rgba(96, 214, 180, .52);
      background: rgba(16, 52, 45, .58);
      color: #d6ffef;
    }

    .status[data-kind="error"] {
      border-color: rgba(245, 122, 138, .64);
      background: rgba(69, 22, 35, .6);
      color: #ffdbe2;
    }

    .status-head {
      font-size: 12px;
      letter-spacing: .02em;
      opacity: .88;
      margin-bottom: 2px;
    }

    .status-body {
      font-size: 13px;
      white-space: pre-wrap;
    }

    .status-action {
      margin-top: 8px;
    }

    .status-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      color: color-mix(in oklab, var(--accent) 82%, white);
      font-size: 13px;
      font-weight: 600;
    }

    .status-link:hover {
      text-decoration: underline;
    }

    #password-wrap { display: none; }
    #password-wrap.visible { display: block; }
  </style>
</head>
<body>
  <main class="card">
    <a class="back" id="back-btn" href="/login" aria-label="前のページへ戻る">‹</a>
    <h1>認証・再設定</h1>
    <div class="mode-switch">
      <button class="mode-btn" id="mode-confirm" type="button" data-active="true">メール認証</button>
      <button class="mode-btn" id="mode-reset" type="button" data-active="false">パスワード再設定</button>
    </div>

    <label for="email">メールアドレス</label>
    <input id="email" type="email" autocomplete="email" />

    <label for="code">認証コード</label>
    <input id="code" type="text" autocomplete="one-time-code" />

    <div id="password-wrap">
      <label for="new-password">新しいパスワード</label>
      <input id="new-password" type="password" autocomplete="new-password" minlength="8" />
    </div>

    <button class="button" id="primary-btn" type="button">認証を完了する</button>
    <button class="button-ghost" id="resend-btn" type="button">確認コードを再送する</button>
    <a class="button-ghost" href="/login">ログインページへ戻る</a>

    <div class="status" id="status" role="status" aria-live="polite" aria-atomic="true">
      <div class="status-head" id="status-head"></div>
      <div class="status-body" id="status-body"></div>
      <div class="status-action" id="status-action"></div>
    </div>
  </main>

  <script>
    (function () {
      const REGION = "ap-northeast-3";
      const CLIENT_ID = "1tkarvhnc0bmo9ikn598afmg9";
      const COGNITO_IDP_ENDPOINT = `https://cognito-idp.${REGION}.amazonaws.com/`;
      const statusTitles = {
        info: "Information",
        success: "Success",
        error: "Error"
      };

      const params = new URLSearchParams(window.location.search);

      const emailEl = document.getElementById("email");
      const codeEl = document.getElementById("code");
      const newPasswordEl = document.getElementById("new-password");
      const passwordWrap = document.getElementById("password-wrap");
      const primaryBtn = document.getElementById("primary-btn");
      const resendBtn = document.getElementById("resend-btn");
      const modeConfirmBtn = document.getElementById("mode-confirm");
      const modeResetBtn = document.getElementById("mode-reset");
      const statusEl = document.getElementById("status");
      const statusHeadEl = document.getElementById("status-head");
      const statusBodyEl = document.getElementById("status-body");
      const statusActionEl = document.getElementById("status-action");

      const initialEmail = (params.get("email") || "").trim();
      if (initialEmail) {
        emailEl.value = initialEmail;
      }

      let mode = params.get("mode") === "reset" ? "reset" : "confirm";

      function setStatus(kind, message, title, action) {
        if (!message) {
          statusEl.dataset.state = "hidden";
          statusEl.dataset.kind = "";
          statusHeadEl.textContent = "";
          statusBodyEl.textContent = "";
          statusActionEl.innerHTML = "";
          return;
        }

        statusEl.dataset.state = "visible";
        statusEl.dataset.kind = kind || "info";
        statusHeadEl.textContent = title || statusTitles[kind] || statusTitles.info;
        statusBodyEl.textContent = message;
        statusActionEl.innerHTML = "";
        if (action && action.href && action.label) {
          const anchor = document.createElement("a");
          anchor.className = "status-link";
          anchor.href = action.href;
          anchor.textContent = action.label;
          statusActionEl.appendChild(anchor);
        }
      }

      function normalizeCognitoErrorMessage(rawMessage) {
        const message = String(rawMessage || "");
        if (!message) return "処理に失敗しました。時間をおいて再試行してください。";

        if (message.includes("CodeMismatchException")) {
          return "認証コードが正しくありません。メール内の最新コードを入力してください。";
        }
        if (message.includes("ExpiredCodeException")) {
          return "認証コードの有効期限が切れています。コードを再送してください。";
        }
        if (message.includes("UserNotFoundException")) {
          return "このメールアドレスのアカウントが見つかりません。先に新規登録してください。";
        }
        if (message.includes("NotAuthorizedException")) {
          return "この操作は現在の状態では実行できません。コード再送またはログインをお試しください。";
        }
        if (message.includes("TooManyRequestsException")) {
          return "試行回数が多いため一時的に制限されています。数分後に再試行してください。";
        }
        if (message.includes("InvalidPasswordException")) {
          return "パスワード要件を満たしていません。英字・数字を含む8文字以上で設定してください。";
        }
        return message.replace(/^.*?:\s*/, "").trim() || "認証処理に失敗しました。";
      }

      function setMode(nextMode) {
        mode = nextMode === "reset" ? "reset" : "confirm";
        modeConfirmBtn.dataset.active = mode === "confirm" ? "true" : "false";
        modeResetBtn.dataset.active = mode === "reset" ? "true" : "false";

        const resetMode = mode === "reset";
        passwordWrap.classList.toggle("visible", resetMode);
        primaryBtn.textContent = resetMode ? "パスワードを更新する" : "認証を完了する";
        resendBtn.textContent = resetMode ? "再設定コードを送信する" : "確認コードを再送する";
      }

      async function cognitoCall(target, payload) {
        const response = await fetch(COGNITO_IDP_ENDPOINT, {
          method: "POST",
          headers: {
            "content-type": "application/x-amz-json-1.1",
            "x-amz-target": `AWSCognitoIdentityProviderService.${target}`
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const message = data.message || data.Message || `${target} failed`;
          throw new Error(message);
        }
        return data;
      }

      async function submitPrimary() {
        const email = emailEl.value.trim().toLowerCase();
        const code = codeEl.value.trim();
        const newPassword = newPasswordEl.value;

        if (!email || !code) {
          setStatus("error", "メールアドレスと認証コードを入力してください。", "入力が必要です");
          return;
        }

        if (mode === "reset" && !newPassword) {
          setStatus("error", "新しいパスワードを入力してください。", "入力が必要です");
          return;
        }

        setStatus("info", "認証処理中です。少しお待ちください。", "処理中");

        try {
          if (mode === "confirm") {
            await cognitoCall("ConfirmSignUp", {
              ClientId: CLIENT_ID,
              Username: email,
              ConfirmationCode: code
            });
            setStatus(
              "success",
              "メール認証が完了しました。ログインページからサインインしてください。",
              "認証完了",
              { label: "ログインページへ", href: `/login?email=${encodeURIComponent(email)}` }
            );
            return;
          }

          await cognitoCall("ConfirmForgotPassword", {
            ClientId: CLIENT_ID,
            Username: email,
            ConfirmationCode: code,
            Password: newPassword
          });
          setStatus(
            "success",
            "パスワードを更新しました。ログインページからサインインしてください。",
            "更新完了",
            { label: "ログインページへ", href: `/login?email=${encodeURIComponent(email)}` }
          );
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          setStatus("error", normalizeCognitoErrorMessage(message), "処理失敗");
        }
      }

      async function resendCode() {
        const email = emailEl.value.trim().toLowerCase();
        if (!email) {
          setStatus("error", "メールアドレスを入力してください。", "入力が必要です");
          return;
        }

        setStatus("info", "コード送信中です。少しお待ちください。", "送信中");

        try {
          if (mode === "confirm") {
            await cognitoCall("ResendConfirmationCode", {
              ClientId: CLIENT_ID,
              Username: email
            });
            setStatus("success", "確認コードを再送しました。受信メールをご確認ください。", "送信完了");
            return;
          }

          await cognitoCall("ForgotPassword", {
            ClientId: CLIENT_ID,
            Username: email
          });
          setStatus("success", "パスワード再設定コードを送信しました。受信メールをご確認ください。", "送信完了");
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          setStatus("error", normalizeCognitoErrorMessage(message), "送信失敗");
        }
      }

      modeConfirmBtn.addEventListener("click", function () {
        setMode("confirm");
      });

      modeResetBtn.addEventListener("click", function () {
        setMode("reset");
      });

      primaryBtn.addEventListener("click", function () {
        void submitPrimary();
      });

      resendBtn.addEventListener("click", function () {
        void resendCode();
      });

      document.getElementById("back-btn").addEventListener("click", function (event) {
        const referrer = document.referrer || "";
        if (referrer.startsWith(window.location.origin) && window.history.length > 1) {
          event.preventDefault();
          window.history.back();
        }
      });

      setMode(mode);
      setStatus("info", "", "");
    })();
  </script>
</body>
</html>
