<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ログイン</title>
  <style>
    :root {
      --bg-0: #081222;
      --bg-1: #10243b;
      --bg-2: #1a2f44;
      --text: #ebf3ff;
      --muted: #a7bdd9;
      --panel: rgba(12, 22, 39, .76);
      --border: rgba(145, 183, 227, .3);
      --accent: #57c4df;
      --accent-strong: #3cacc7;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      color: var(--text);
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      background:
        radial-gradient(circle at 12% 10%, rgba(87, 196, 223, .22), transparent 42%),
        radial-gradient(circle at 90% 7%, rgba(255, 154, 95, .15), transparent 36%),
        linear-gradient(158deg, var(--bg-0) 0%, var(--bg-1) 50%, var(--bg-2) 100%);
      padding: 16px;
    }

    .card {
      width: min(92vw, 480px);
      border-radius: 24px;
      border: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 24px 56px rgba(3,7,16,.52), inset 0 1px 0 rgba(169,208,255,.15);
      padding: 20px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 30px;
      line-height: 1.15;
    }

    p {
      color: var(--muted);
      line-height: 1.75;
      margin: 0 0 12px;
      font-size: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      margin: 10px 0 6px;
      color: var(--muted);
    }

    input {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(17, 33, 52, .66);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }

    input:focus {
      border-color: color-mix(in oklab, var(--accent) 68%, white);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 24%, transparent);
    }

    .button {
      border: 1px solid color-mix(in oklab, var(--accent) 65%, white);
      background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%);
      color: white;
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    .button-ghost {
      margin-top: 8px;
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .5);
      color: var(--text);
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      text-align: center;
    }

    .divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 12px 0;
      color: var(--muted);
      font-size: 12px;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .status {
      margin-top: 10px;
      border: 1px solid var(--border);
      background: rgba(20, 36, 57, .5);
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      white-space: pre-wrap;
      display: none;
    }

    .status.visible { display: block; }
  </style>
</head>
<body>
  <main class="card">
    <h1>ログイン</h1>
    <p>ログイン済みユーザーのみ、LLM質問機能を利用できます。</p>

    <button class="button-ghost" id="google-login-btn" type="button">Googleでログイン</button>

    <div class="divider">または</div>

    <label for="email">メールアドレス</label>
    <input id="email" type="email" autocomplete="email" />

    <label for="password">パスワード</label>
    <input id="password" type="password" autocomplete="current-password" />

    <button class="button" id="login-btn" type="button">ログイン</button>
    <button class="button-ghost" id="signup-btn" type="button">新規登録</button>

    <a class="button-ghost" href="/">トップへ戻る</a>

    <div class="status" id="status"></div>
  </main>

  <script>
    (function () {
      const REGION = "ap-northeast-3";
      const CLIENT_ID = "1tkarvhnc0bmo9ikn598afmg9";
      const COGNITO_DOMAIN = "https://noema-437089831576-auth.auth.ap-northeast-3.amazoncognito.com";
      const COGNITO_IDP_ENDPOINT = `https://cognito-idp.${REGION}.amazonaws.com/`;
      const TOKEN_KEY = "noema_id_token";

      const emailEl = document.getElementById("email");
      const passwordEl = document.getElementById("password");
      const statusEl = document.getElementById("status");

      function setStatus(message) {
        statusEl.textContent = message;
        statusEl.classList.toggle("visible", Boolean(message));
      }

      async function cognitoCall(target, payload) {
        const response = await fetch(COGNITO_IDP_ENDPOINT, {
          method: "POST",
          headers: {
            "content-type": "application/x-amz-json-1.1",
            "x-amz-target": `AWSCognitoIdentityProviderService.${target}`
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const message = data.message || data.Message || `${target} failed`;
          throw new Error(message);
        }

        return data;
      }

      function randomString(length) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
        const values = crypto.getRandomValues(new Uint8Array(length));
        let result = "";
        values.forEach((value) => {
          result += chars[value % chars.length];
        });
        return result;
      }

      function base64UrlEncode(arrayBuffer) {
        const bytes = new Uint8Array(arrayBuffer);
        let str = "";
        bytes.forEach((byte) => {
          str += String.fromCharCode(byte);
        });
        return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
      }

      async function createChallenge(verifier) {
        const data = new TextEncoder().encode(verifier);
        const digest = await crypto.subtle.digest("SHA-256", data);
        return base64UrlEncode(digest);
      }

      async function loginWithGoogle() {
        try {
          setStatus("Googleログインへ遷移します...");
          const verifier = randomString(96);
          const challenge = await createChallenge(verifier);
          const state = randomString(40);
          const redirectUri = `${window.location.origin}/api/auth/callback/cognito`;

          sessionStorage.setItem("noema_pkce_verifier", verifier);
          sessionStorage.setItem("noema_pkce_state", state);

          const params = new URLSearchParams({
            response_type: "code",
            client_id: CLIENT_ID,
            redirect_uri: redirectUri,
            scope: "openid email profile",
            state,
            code_challenge_method: "S256",
            code_challenge: challenge,
            identity_provider: "Google"
          });

          window.location.href = `${COGNITO_DOMAIN}/oauth2/authorize?${params.toString()}`;
        } catch (error) {
          setStatus(`Googleログインの開始に失敗: ${error instanceof Error ? error.message : String(error)}`);
        }
      }

      async function login() {
        const email = emailEl.value.trim().toLowerCase();
        const password = passwordEl.value;
        if (!email || !password) {
          setStatus("メールアドレスとパスワードを入力してください。");
          return;
        }

        setStatus("ログイン処理中...");

        try {
          const data = await cognitoCall("InitiateAuth", {
            AuthFlow: "USER_PASSWORD_AUTH",
            ClientId: CLIENT_ID,
            AuthParameters: {
              USERNAME: email,
              PASSWORD: password
            }
          });

          const idToken = data?.AuthenticationResult?.IdToken;
          if (!idToken) {
            throw new Error("IDトークンが取得できませんでした。");
          }

          localStorage.setItem(TOKEN_KEY, idToken);
          setStatus("ログイン成功。トップへ戻ります...");
          setTimeout(() => {
            window.location.href = "/";
          }, 450);
        } catch (error) {
          setStatus(`ログイン失敗: ${error instanceof Error ? error.message : String(error)}`);
        }
      }

      async function signup() {
        const email = emailEl.value.trim().toLowerCase();
        const password = passwordEl.value;
        if (!email || !password) {
          setStatus("新規登録にはメールアドレスとパスワードを入力してください。");
          return;
        }

        setStatus("新規登録処理中...");

        try {
          await cognitoCall("SignUp", {
            ClientId: CLIENT_ID,
            Username: email,
            Password: password,
            UserAttributes: [{ Name: "email", Value: email }]
          });

          setStatus("登録を受け付けました。メール認証が必要な場合は、メール確認後にログインしてください。");
        } catch (error) {
          setStatus(`新規登録失敗: ${error instanceof Error ? error.message : String(error)}`);
        }
      }

      document.getElementById("google-login-btn").addEventListener("click", function () {
        void loginWithGoogle();
      });

      document.getElementById("login-btn").addEventListener("click", function () {
        void login();
      });

      document.getElementById("signup-btn").addEventListener("click", function () {
        void signup();
      });

      const existing = localStorage.getItem(TOKEN_KEY);
      if (existing) {
        setStatus("既にログイン済みです。再ログインする場合のみ入力してください。");
      }
    })();
  </script>
</body>
</html>
