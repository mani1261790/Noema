<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noema Login</title>
  <style>
    :root {
      --bg-0: #081222;
      --bg-1: #10243b;
      --bg-2: #1a2f44;
      --text: #ebf3ff;
      --muted: #a7bdd9;
      --panel: rgba(12, 22, 39, .76);
      --border: rgba(145, 183, 227, .3);
      --accent: #57c4df;
      --accent-strong: #3cacc7;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      color: var(--text);
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      background:
        radial-gradient(circle at 12% 10%, rgba(87, 196, 223, .22), transparent 42%),
        radial-gradient(circle at 90% 7%, rgba(255, 154, 95, .15), transparent 36%),
        linear-gradient(158deg, var(--bg-0) 0%, var(--bg-1) 50%, var(--bg-2) 100%);
      padding: 16px;
    }

    .card {
      width: min(92vw, 560px);
      border-radius: 24px;
      border: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 24px 56px rgba(3,7,16,.52), inset 0 1px 0 rgba(169,208,255,.15);
      padding: 20px;
    }

    .mono {
      letter-spacing: .16em;
      text-transform: uppercase;
      color: var(--accent);
      font-size: 11px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      margin: 2px 0;
    }

    h1 {
      margin: 2px 0 8px;
      font-size: 34px;
      line-height: 1.15;
    }

    p { color: var(--muted); line-height: 1.75; margin: 0 0 12px; }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tab {
      border: 1px solid var(--border);
      background: rgba(19, 36, 55, .5);
      color: var(--text);
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .tab.active {
      border-color: color-mix(in oklab, var(--accent) 68%, white);
      color: white;
      background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%);
    }

    label {
      display: block;
      font-size: 13px;
      margin: 10px 0 6px;
      color: var(--muted);
    }

    input {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(17, 33, 52, .66);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }

    input:focus {
      border-color: color-mix(in oklab, var(--accent) 68%, white);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 24%, transparent);
    }

    .button {
      border: 1px solid color-mix(in oklab, var(--accent) 65%, white);
      background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%);
      color: white;
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 12px;
    }

    .button-ghost {
      margin-top: 8px;
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .5);
      color: var(--text);
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
    }

    .actions { margin-top: 14px; }

    .note {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.7;
    }

    .status {
      margin-top: 10px;
      border: 1px solid var(--border);
      background: rgba(20, 36, 57, .5);
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <main class="card">
    <p class="mono">Noema Auth</p>
    <h1>ログイン / 新規登録</h1>
    <p>ログイン済みユーザーのみ、LLM質問機能を利用できます。</p>

    <div class="tabs">
      <button class="tab active" id="tab-login" type="button">ログイン</button>
      <button class="tab" id="tab-signup" type="button">新規登録</button>
      <button class="tab" id="tab-confirm" type="button">確認コード</button>
    </div>

    <section id="panel-login">
      <label for="login-email">メールアドレス</label>
      <input id="login-email" type="email" autocomplete="email" />

      <label for="login-password">パスワード</label>
      <input id="login-password" type="password" autocomplete="current-password" />

      <button class="button" id="login-btn" type="button">ログイン</button>
      <button class="button-ghost" id="to-signup-btn" type="button">アカウントを作成する</button>
    </section>

    <section id="panel-signup" class="hidden">
      <label for="signup-email">メールアドレス</label>
      <input id="signup-email" type="email" autocomplete="email" />

      <label for="signup-password">パスワード（8文字以上）</label>
      <input id="signup-password" type="password" autocomplete="new-password" />

      <button class="button" id="signup-btn" type="button">新規登録</button>
      <button class="button-ghost" id="resend-btn" type="button">確認コードを再送信</button>
    </section>

    <section id="panel-confirm" class="hidden">
      <label for="confirm-email">メールアドレス</label>
      <input id="confirm-email" type="email" autocomplete="email" />

      <label for="confirm-code">確認コード</label>
      <input id="confirm-code" type="text" inputmode="numeric" />

      <button class="button" id="confirm-btn" type="button">確認して有効化</button>
      <button class="button-ghost" id="to-login-btn" type="button">ログイン画面に戻る</button>
    </section>

    <div class="actions">
      <a class="button-ghost" href="/">トップへ戻る</a>
    </div>

    <p class="note">
      Googleログインは後続フェーズで追加します。現在はメールアドレス + パスワードで利用可能です。
    </p>

    <div class="status" id="status">入力後に実行してください。</div>
  </main>

  <script>
    (function () {
      const REGION = "ap-northeast-3";
      const CLIENT_ID = "1tkarvhnc0bmo9ikn598afmg9";
      const COGNITO_IDP_ENDPOINT = `https://cognito-idp.${REGION}.amazonaws.com/`;
      const TOKEN_KEY = "noema_id_token";

      const tabLogin = document.getElementById("tab-login");
      const tabSignup = document.getElementById("tab-signup");
      const tabConfirm = document.getElementById("tab-confirm");

      const panelLogin = document.getElementById("panel-login");
      const panelSignup = document.getElementById("panel-signup");
      const panelConfirm = document.getElementById("panel-confirm");

      const loginEmail = document.getElementById("login-email");
      const loginPassword = document.getElementById("login-password");
      const signupEmail = document.getElementById("signup-email");
      const signupPassword = document.getElementById("signup-password");
      const confirmEmail = document.getElementById("confirm-email");
      const confirmCode = document.getElementById("confirm-code");

      const statusEl = document.getElementById("status");

      function setStatus(message) {
        statusEl.textContent = message;
      }

      function setTab(name) {
        const tabs = [
          ["login", tabLogin, panelLogin],
          ["signup", tabSignup, panelSignup],
          ["confirm", tabConfirm, panelConfirm]
        ];

        tabs.forEach(([id, tab, panel]) => {
          const active = id === name;
          tab.classList.toggle("active", active);
          panel.classList.toggle("hidden", !active);
        });
      }

      async function cognitoCall(target, payload) {
        const response = await fetch(COGNITO_IDP_ENDPOINT, {
          method: "POST",
          headers: {
            "content-type": "application/x-amz-json-1.1",
            "x-amz-target": `AWSCognitoIdentityProviderService.${target}`
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const message = data.message || data.Message || `${target} failed`;
          throw new Error(message);
        }

        return data;
      }

      async function login() {
        const email = loginEmail.value.trim().toLowerCase();
        const password = loginPassword.value;
        if (!email || !password) {
          setStatus("メールアドレスとパスワードを入力してください。");
          return;
        }

        setStatus("ログイン処理中...");

        try {
          const data = await cognitoCall("InitiateAuth", {
            AuthFlow: "USER_PASSWORD_AUTH",
            ClientId: CLIENT_ID,
            AuthParameters: {
              USERNAME: email,
              PASSWORD: password
            }
          });

          const idToken = data?.AuthenticationResult?.IdToken;
          if (!idToken) {
            throw new Error("IDトークンが取得できませんでした。");
          }

          localStorage.setItem(TOKEN_KEY, idToken);
          setStatus("ログイン成功。トップへ戻ります...");
          setTimeout(() => {
            window.location.href = "/";
          }, 500);
        } catch (error) {
          setStatus(`ログイン失敗: ${error instanceof Error ? error.message : String(error)}`);
        }
      }

      async function signup() {
        const email = signupEmail.value.trim().toLowerCase();
        const password = signupPassword.value;
        if (!email || !password) {
          setStatus("メールアドレスとパスワードを入力してください。");
          return;
        }

        setStatus("新規登録処理中...");

        try {
          await cognitoCall("SignUp", {
            ClientId: CLIENT_ID,
            Username: email,
            Password: password,
            UserAttributes: [{ Name: "email", Value: email }]
          });

          confirmEmail.value = email;
          setTab("confirm");
          setStatus("確認コードをメール送信しました。確認コードタブで有効化してください。");
        } catch (error) {
          setStatus(`新規登録失敗: ${error instanceof Error ? error.message : String(error)}`);
        }
      }

      async function confirm() {
        const email = confirmEmail.value.trim().toLowerCase();
        const code = confirmCode.value.trim();
        if (!email || !code) {
          setStatus("メールアドレスと確認コードを入力してください。");
          return;
        }

        setStatus("確認処理中...");

        try {
          await cognitoCall("ConfirmSignUp", {
            ClientId: CLIENT_ID,
            Username: email,
            ConfirmationCode: code
          });
          setTab("login");
          loginEmail.value = email;
          setStatus("確認完了。ログインしてください。");
        } catch (error) {
          setStatus(`確認失敗: ${error instanceof Error ? error.message : String(error)}`);
        }
      }

      async function resendCode() {
        const email = signupEmail.value.trim().toLowerCase();
        if (!email) {
          setStatus("確認コード再送信にはメールアドレスを入力してください。");
          return;
        }

        setStatus("確認コード再送信中...");

        try {
          await cognitoCall("ResendConfirmationCode", {
            ClientId: CLIENT_ID,
            Username: email
          });
          setStatus("確認コードを再送信しました。");
        } catch (error) {
          setStatus(`再送信失敗: ${error instanceof Error ? error.message : String(error)}`);
        }
      }

      tabLogin.addEventListener("click", function () { setTab("login"); });
      tabSignup.addEventListener("click", function () { setTab("signup"); });
      tabConfirm.addEventListener("click", function () { setTab("confirm"); });

      document.getElementById("login-btn").addEventListener("click", function () { void login(); });
      document.getElementById("signup-btn").addEventListener("click", function () { void signup(); });
      document.getElementById("confirm-btn").addEventListener("click", function () { void confirm(); });
      document.getElementById("resend-btn").addEventListener("click", function () { void resendCode(); });

      document.getElementById("to-signup-btn").addEventListener("click", function () { setTab("signup"); });
      document.getElementById("to-login-btn").addEventListener("click", function () { setTab("login"); });

      const existing = localStorage.getItem(TOKEN_KEY);
      if (existing) {
        setStatus("現在ログイン済みのトークンがあります。再ログインする場合は入力して実行してください。");
      }
    })();
  </script>
</body>
</html>
