<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ログイン</title>
  <style>
    :root {
      --bg-0: #081222;
      --bg-1: #10243b;
      --bg-2: #1a2f44;
      --text: #ebf3ff;
      --muted: #a7bdd9;
      --panel: rgba(12, 22, 39, .76);
      --border: rgba(145, 183, 227, .3);
      --accent: #57c4df;
      --accent-strong: #3cacc7;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      color: var(--text);
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      background:
        radial-gradient(circle at 12% 10%, rgba(87, 196, 223, .22), transparent 42%),
        radial-gradient(circle at 90% 7%, rgba(255, 154, 95, .15), transparent 36%),
        linear-gradient(158deg, var(--bg-0) 0%, var(--bg-1) 50%, var(--bg-2) 100%);
      padding: 16px;
    }

    .card {
      width: min(92vw, 480px);
      border-radius: 24px;
      border: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 24px 56px rgba(3,7,16,.52), inset 0 1px 0 rgba(169,208,255,.15);
      padding: 20px;
      position: relative;
    }

    .back {
      position: absolute;
      top: 12px;
      left: 12px;
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .5);
      color: var(--text);
      border-radius: 10px;
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      text-decoration: none;
      line-height: 1;
    }

    h1 {
      margin: 0 0 8px 44px;
      font-size: 30px;
      line-height: 1.15;
    }

    p {
      color: var(--muted);
      line-height: 1.75;
      margin: 0 0 12px;
      font-size: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      margin: 10px 0 6px;
      color: var(--muted);
    }

    input {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(17, 33, 52, .66);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }

    input:focus {
      border-color: color-mix(in oklab, var(--accent) 68%, white);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 24%, transparent);
    }

    .button {
      border: 1px solid color-mix(in oklab, var(--accent) 65%, white);
      background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%);
      color: white;
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    .button-ghost {
      margin-top: 8px;
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .5);
      color: var(--text);
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      text-align: center;
    }

    a.button-ghost {
      display: block;
      text-decoration: none;
    }

    .status {
      margin-top: 10px;
      border: 1px solid transparent;
      background: transparent;
      border-radius: 14px;
      padding: 0;
      line-height: 1.65;
      opacity: 0;
      transform: translateY(-2px);
      max-height: 0;
      overflow: hidden;
      transition: opacity 160ms ease, transform 160ms ease, max-height 180ms ease, padding 160ms ease;
    }

    .status[data-state="visible"] {
      opacity: 1;
      transform: translateY(0);
      max-height: 220px;
      padding: 10px 12px;
    }

    .status[data-kind="info"] {
      border-color: color-mix(in oklab, var(--accent) 30%, var(--border));
      background: rgba(20, 40, 64, .56);
      color: color-mix(in oklab, var(--text) 86%, white);
    }

    .status[data-kind="success"] {
      border-color: rgba(96, 214, 180, .52);
      background: rgba(16, 52, 45, .58);
      color: #d6ffef;
    }

    .status[data-kind="error"] {
      border-color: rgba(245, 122, 138, .64);
      background: rgba(69, 22, 35, .6);
      color: #ffdbe2;
    }

    .status-head {
      font-size: 12px;
      letter-spacing: .02em;
      opacity: .88;
      margin-bottom: 2px;
    }

    .status-body {
      font-size: 13px;
      white-space: pre-wrap;
    }

    .status-action {
      margin-top: 8px;
    }

    .status-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      color: color-mix(in oklab, var(--accent) 82%, white);
      font-size: 13px;
      font-weight: 600;
    }

    .status-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <main class="card">
    <a class="back" id="back-btn" href="/" aria-label="前のページへ戻る">‹</a>
    <h1>ログイン</h1>
    <p>ログイン済みユーザーのみ、LLM質問機能を利用できます。</p>

    <label for="email">メールアドレス</label>
    <input id="email" type="email" autocomplete="email" />

    <label for="password">パスワード</label>
    <input id="password" type="password" autocomplete="current-password" />

    <button class="button" id="login-btn" type="button">ログイン</button>
    <button class="button-ghost" id="signup-btn" type="button">新規登録</button>
    <a class="button-ghost" id="verify-entry-link" href="/verify.html">認証・再設定はこちら</a>

    <div class="status" id="status" role="status" aria-live="polite" aria-atomic="true">
      <div class="status-head" id="status-head"></div>
      <div class="status-body" id="status-body"></div>
      <div class="status-action" id="status-action"></div>
    </div>
  </main>

  <script>
    (function () {
      const REGION = "ap-northeast-3";
      const CLIENT_ID = "1tkarvhnc0bmo9ikn598afmg9";
      const COGNITO_IDP_ENDPOINT = `https://cognito-idp.${REGION}.amazonaws.com/`;
      const TOKEN_KEY = "noema_id_token";
      const statusTitles = {
        info: "Information",
        success: "Success",
        error: "Error"
      };

      const emailEl = document.getElementById("email");
      const passwordEl = document.getElementById("password");
      const statusEl = document.getElementById("status");
      const statusHeadEl = document.getElementById("status-head");
      const statusBodyEl = document.getElementById("status-body");
      const statusActionEl = document.getElementById("status-action");
      const params = new URLSearchParams(window.location.search);

      const initialEmail = (params.get("email") || "").trim();
      if (initialEmail) {
        emailEl.value = initialEmail;
      }

      function buildVerifyUrl(email, mode) {
        const params = new URLSearchParams();
        if (email) params.set("email", email);
        if (mode) params.set("mode", mode);
        const suffix = params.toString();
        return `/verify.html${suffix ? `?${suffix}` : ""}`;
      }

      function setStatus(kind, message, title, action) {
        if (!message) {
          statusEl.dataset.state = "hidden";
          statusEl.dataset.kind = "";
          statusHeadEl.textContent = "";
          statusBodyEl.textContent = "";
          statusActionEl.innerHTML = "";
          return;
        }

        statusEl.dataset.state = "visible";
        statusEl.dataset.kind = kind || "info";
        statusHeadEl.textContent = title || statusTitles[kind] || statusTitles.info;
        statusBodyEl.textContent = message;
        statusActionEl.innerHTML = "";
        if (action && action.href && action.label) {
          const anchor = document.createElement("a");
          anchor.className = "status-link";
          anchor.href = action.href;
          anchor.textContent = action.label;
          statusActionEl.appendChild(anchor);
        }
      }

      function normalizeCognitoErrorMessage(rawMessage) {
        const message = String(rawMessage || "");
        if (!message) return "認証に失敗しました。時間をおいて再試行してください。";

        if (message.includes("NotAuthorizedException")) {
          return "メールアドレスまたはパスワードが正しくありません。";
        }
        if (message.includes("UserNotConfirmedException")) {
          return "メール確認が完了していません。受信メールの確認手続きを先に実行してください。";
        }
        if (message.includes("UsernameExistsException")) {
          return "このメールアドレスは既に登録済みです。ログインをお試しください。";
        }
        if (message.includes("InvalidPasswordException")) {
          return "パスワード要件を満たしていません。英字・数字を含む8文字以上で設定してください。";
        }
        if (message.includes("TooManyRequestsException")) {
          return "試行回数が多いため一時的に制限されています。数分後に再試行してください。";
        }
        return message.replace(/^.*?:\s*/, "").trim() || "認証処理に失敗しました。";
      }

      async function cognitoCall(target, payload) {
        const response = await fetch(COGNITO_IDP_ENDPOINT, {
          method: "POST",
          headers: {
            "content-type": "application/x-amz-json-1.1",
            "x-amz-target": `AWSCognitoIdentityProviderService.${target}`
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const message = data.message || data.Message || `${target} failed`;
          throw new Error(message);
        }

        return data;
      }

      async function login() {
        const email = emailEl.value.trim().toLowerCase();
        const password = passwordEl.value;
        if (!email || !password) {
          setStatus("error", "メールアドレスとパスワードを入力してください。", "入力が必要です");
          return;
        }

        setStatus("info", "ログイン処理中です。少しお待ちください。", "サインイン中");

        try {
          const data = await cognitoCall("InitiateAuth", {
            AuthFlow: "USER_PASSWORD_AUTH",
            ClientId: CLIENT_ID,
            AuthParameters: {
              USERNAME: email,
              PASSWORD: password
            }
          });

          const idToken = data?.AuthenticationResult?.IdToken;
          if (!idToken) {
            throw new Error("IDトークンが取得できませんでした。");
          }

          localStorage.setItem(TOKEN_KEY, idToken);
          setStatus("success", "ログインに成功しました。トップページへ移動します。", "完了");
          setTimeout(() => {
            window.location.href = "/";
          }, 450);
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          setStatus("error", normalizeCognitoErrorMessage(message), "ログイン失敗");
        }
      }

      async function signup() {
        const email = emailEl.value.trim().toLowerCase();
        const password = passwordEl.value;
        if (!email || !password) {
          setStatus("error", "新規登録にはメールアドレスとパスワードを入力してください。", "入力が必要です");
          return;
        }

        setStatus("info", "新規登録処理中です。少しお待ちください。", "アカウント作成中");

        try {
          await cognitoCall("SignUp", {
            ClientId: CLIENT_ID,
            Username: email,
            Password: password,
            UserAttributes: [{ Name: "email", Value: email }]
          });

          setStatus(
            "success",
            "登録を受け付けました。メールに届いた確認コードを入力して認証を完了してください。",
            "登録完了",
            { label: "認証・再設定はこちら", href: buildVerifyUrl(email, "confirm") }
          );
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          if (message.includes("UsernameExistsException")) {
            let handled = false;

            try {
              await cognitoCall("ResendConfirmationCode", {
                ClientId: CLIENT_ID,
                Username: email
              });
              handled = true;
              setStatus(
                "success",
                "このメールアドレスは既に登録済みです。確認コードを再送しました。認証・再設定ページで認証を完了してください。",
                "登録受付済み",
                { label: "認証・再設定はこちら", href: buildVerifyUrl(email, "confirm") }
              );
            } catch {}

            if (!handled) {
              try {
                await cognitoCall("ForgotPassword", {
                  ClientId: CLIENT_ID,
                  Username: email
                });
                handled = true;
                setStatus(
                  "success",
                  "このメールアドレスは既に存在するため、パスワード再設定コードを送信しました。認証・再設定ページで新しいパスワードを設定してください。",
                  "再設定コード送信済み",
                  { label: "認証・再設定はこちら", href: buildVerifyUrl(email, "reset") }
                );
              } catch {}
            }

            if (handled) return;
          }

          setStatus("error", normalizeCognitoErrorMessage(message), "登録失敗");
        }
      }

      document.getElementById("login-btn").addEventListener("click", function () {
        void login();
      });

      document.getElementById("signup-btn").addEventListener("click", function () {
        void signup();
      });

      document.getElementById("back-btn").addEventListener("click", function (event) {
        const referrer = document.referrer || "";
        if (referrer.startsWith(window.location.origin) && window.history.length > 1) {
          event.preventDefault();
          window.history.back();
        }
      });

      const existing = localStorage.getItem(TOKEN_KEY);
      if (existing) {
        setStatus("info", "既にログイン済みです。再ログインが必要な場合のみ入力してください。", "セッション有効");
      } else {
        setStatus("info", "", "");
      }
    })();
  </script>
</body>
</html>
