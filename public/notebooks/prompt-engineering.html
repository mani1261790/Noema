<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>prompt-engineering</title>
  <link rel="stylesheet" href="/highlight/atom-one-dark.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" />
  <style>
    :root {
      --bg-0: #f3f8fb;
      --bg-1: #d7e8f4;
      --bg-2: #f9f1e7;
      --text: #09162b;
      --muted: #44556f;
      --panel: rgba(255,255,255,.72);
      --border: rgba(255,255,255,.62);
      --code-bg: #09131a;
      --code-text: #e6f0f5;
      --shadow: 0 24px 54px rgba(10, 26, 54, 0.18), inset 0 1px 0 rgba(255,255,255,.62);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-0: #071225;
        --bg-1: #0f2238;
        --bg-2: #1a2f44;
        --text: #ebf3ff;
        --muted: #9db3cf;
        --panel: rgba(12, 21, 40, 0.74);
        --border: rgba(145, 183, 227, 0.33);
        --code-bg: #040b17;
        --code-text: #e4efff;
        --shadow: 0 30px 66px rgba(2, 7, 16, 0.58), inset 0 1px 0 rgba(166,205,255,.16);
      }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      padding: 2rem 1rem;
      color: var(--text);
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      background:
        radial-gradient(circle at 12% 12%, rgba(87,196,223,.18), transparent 44%),
        radial-gradient(circle at 88% 5%, rgba(255, 155, 96, 0.16), transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(109, 196, 255, 0.2), transparent 45%),
        linear-gradient(155deg, var(--bg-0) 0%, var(--bg-1) 48%, var(--bg-2) 100%);
    }
    main {
      max-width: 980px;
      margin: 0 auto;
      border-radius: 24px;
      border: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(20px) saturate(145%);
      -webkit-backdrop-filter: blur(20px) saturate(145%);
      box-shadow: var(--shadow);
      padding: 1.25rem 1.25rem 1.5rem;
    }
    .prose-noema h1, .prose-noema h2, .prose-noema h3 {
      line-height: 1.25;
      margin-top: 1.25rem;
      margin-bottom: .65rem;
    }
    .prose-noema h1 { margin-top: .1rem; font-size: 1.8rem; }
    .prose-noema h2 { font-size: 1.35rem; }
    .prose-noema p {
      line-height: 1.85;
      color: var(--text);
      margin: .7rem 0;
    }
    .prose-noema ul, .prose-noema ol {
      margin: .7rem 0;
      padding-left: 1.4rem;
    }
    .prose-noema ul { list-style: disc; }
    .prose-noema ol { list-style: decimal; }
    .prose-noema li { margin: .28rem 0; line-height: 1.72; }
    .prose-noema a { color: inherit; text-underline-offset: 2px; }
    .prose-noema pre {
      background: var(--code-bg);
      color: var(--code-text);
      border-radius: 12px;
      padding: 1rem;
      overflow: auto;
      border: 1px solid rgba(255,255,255,.12);
    }
    .prose-noema code {
      font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
    }
    .prose-noema img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <main>
<article class="prose-noema">
<h1 id="プロンプトエンジニアリング">プロンプトエンジニアリング</h1>
<h2 id="問題設定">問題設定</h2>
<p>プロンプトエンジニアリングでは、モデル呼び出し以前に入力設計と評価設計を固める習慣を作ります。</p>
<p>前提: 確率的な予測モデルの見方と、深層学習の基礎が前提です。</p>
<p>到達目標: プロンプト、事前学習、微調整、RAG、効率化を実装視点で横断し、設計判断を言語化できる状態にします。</p>
<p>ここで扱う中心語は 「トークン」、「事前学習」、「微調整」、「RAG」、「推論最適化」、「プロンプトエンジニアリング」 です。用語を先に暗記するのではなく、コード実行の結果と結びつけて理解します。</p>
<p>このノートは LLM 分野の初学者向けに、説明とコードを交互に読み進める設計です。最初から完璧に理解する必要はありません。大切なのは、各コードの目的を一文で言えることと、出力が変わる理由を自分で確かめることです。</p>

<h2 id="検証-1-トークン近似を体験する">検証 1: トークン近似を体験する</h2>
<p>最初に、入力長とトークン量の関係を簡易計測します。コスト管理の第一歩です。</p>

<pre><code class="language-python">text = &#39;大規模言語モデルは文脈の与え方で応答品質が大きく変わる。&#39;
char_len = len(text)
space_tokens = text.split()
rough_tokens = max(1, char_len // 2)
print(&#39;chars=&#39;, char_len, &#39;space_tokens=&#39;, len(space_tokens), &#39;rough_tokens=&#39;, rough_tokens)</code></pre>
<p>厳密なトークン化ではありませんが、入力を短く保つ設計感覚を作るには十分です。</p>
<p>この節では、トークン が入出力のどこを決めるかを中心に読める状態になれば十分です。</p>

<h2 id="検証-2-制約付きプロンプト設計">検証 2: 制約付きプロンプト設計</h2>
<p>プロンプトは長く書くより、制約を明確化する方が効果的です。ここではテンプレート化を練習します。</p>

<pre><code class="language-python">task = &#39;連鎖律を初学者向けに説明する&#39;
rules = [&#39;120字以内&#39;, &#39;式は1つまで&#39;, &#39;最後に確認問題を1問&#39;]
template = f&quot;課題: {task}\n制約: {&#39;; &#39;.join(rules)}\n出力形式: 段落1つ&quot;
print(template)
print(&#39;template_len=&#39;, len(template))</code></pre>
<p>この設計は生成APIを呼ばなくても、入力仕様の品質点検として価値があります。</p>
<p>この節では、トークン が入出力のどこを決めるかを中心に読める状態になれば十分です。</p>

<h2 id="定義の確認">定義の確認</h2>
<ol>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mi>t</mi></msub><mi>h</mi><mi>e</mi><mi>t</mi><mi>a</mi><mo>(</mo><msub><mi>x</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mo>&lt;</mo></msub><mi>t</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">p_theta(x_t | x_&lt;t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit">h</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mopen">(</span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mrel">&lt;</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit">t</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>C</mi></msub><mi>E</mi><mo>=</mo><mo>−</mo><mi>s</mi><mi>u</mi><msub><mi>m</mi><mi>t</mi></msub><mi>l</mi><mi>o</mi><mi>g</mi><msub><mi>p</mi><mi>t</mi></msub><mi>h</mi><mi>e</mi><mi>t</mi><mi>a</mi><mo>(</mo><msub><mi>x</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mo>&lt;</mo></msub><mi>t</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">L_CE = - sum_t log p_theta(x_t | x_&lt;t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">L</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.07153em;">C</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit" style="margin-right:0.05764em;">E</span><span class="mrel">=</span><span class="mord">−</span><span class="mord mathit">s</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit">m</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">o</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit">h</span><span class="mord mathit">e</span><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mopen">(</span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">t</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span><span class="mord"><span class="mord mathit">x</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mrel">&lt;</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit">t</span><span class="mclose">)</span></span></span></span></li>
</ol>

<h2 id="検証-3-検索文脈を結合する">検証 3: 検索文脈を結合する</h2>
<p>ここで RAG の最小形を実装します。質問と関連文を結合し、回答入力を作る流れを確認します。</p>

<pre><code class="language-python">question = &#39;ベルマン方程式を高校生向けに説明して&#39;
retrieved = [&#39;価値は将来報酬の割引和で定義する&#39;, &#39;現在価値は次状態価値で再帰的に更新できる&#39;]
context = &#39;\n&#39;.join(f&#39;- {c}&#39; for c in retrieved)
final_input = f&quot;質問:\n{question}\n\n参考文脈:\n{context}\n\n回答:&quot;
print(final_input)</code></pre>
<p>検索文脈を入れる目的は、モデルの記憶に頼りすぎないことです。根拠付き応答を作りやすくなります。</p>
<p>この節では、トークン が入出力のどこを決めるかを中心に読める状態になれば十分です。</p>

<h2 id="検証-4-評価項目を数値化する">検証 4: 評価項目を数値化する</h2>
<p>次に、回答を点検するための簡易スコアを定義します。評価軸を言語化すると改善が継続できます。</p>

<pre><code class="language-python">answer = &#39;ベルマン方程式は、今の価値を次の価値で更新する再帰式です。&#39;
checks = {&#39;length_ok&#39;: len(answer) &lt;= 120, &#39;has_keyword&#39;: &#39;価値&#39; in answer, &#39;has_recurrence&#39;: &#39;再帰&#39; in answer}
score = sum(1 for v in checks.values() if v) / len(checks)
print(&#39;checks=&#39;, checks)
print(&#39;score=&#39;, round(score, 3))</code></pre>
<p>このような軽量評価でも、改善方向を揃える効果があります。実務ではこの評価軸をチームで共有します。</p>
<p>この節では、トークン が入出力のどこを決めるかを中心に読める状態になれば十分です。</p>

<h2 id="検証-5-推論コストを見積もる">検証 5: 推論コストを見積もる</h2>
<p>最後に、入力と出力の長さから概算コストを計算します。モデル選択は性能だけでなく費用とのバランスが必要です。</p>

<pre><code class="language-python">input_tokens = 320
output_tokens = 180
price_per_1k = 0.0012
cost = (input_tokens + output_tokens) / 1000 * price_per_1k
print(&#39;estimated_cost=&#39;, round(cost, 6))</code></pre>
<p>この見積もりを運用前に作ると、スケール時の予算超過を防ぎやすくなります。</p>
<p>この節では、トークン が入出力のどこを決めるかを中心に読める状態になれば十分です。</p>

<h2 id="まとめ">まとめ</h2>
<p>今回のノートで押さえておくべき誤解しやすい点を整理します。</p>
<ol>
<li>プロンプトだけで全問題を解決しようとする</li>
<li>評価指標を決めずに改善を繰り返す</li>
<li>コストと品質のバランスを見ない</li>
</ol>
<p>次は「事前学習」へ進み、今回のコードと何が変わるかを比較してください。</p>

</article>
  </main>
  <script src="/highlight/highlight.min.js"></script>
  <script>
    (function () {
      if (!window.hljs) return;
      document.querySelectorAll("pre code").forEach(function (block) {
        window.hljs.highlightElement(block);
      });
    })();
  </script>
</body>
</html>