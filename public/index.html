<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noema</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/highlight/atom-one-dark.min.css" />
  <style>
    :root {
      --bg-0: #f3f8fb;
      --bg-1: #d7e8f4;
      --bg-2: #f9f1e7;
      --text: #09162b;
      --muted: #44556f;
      --panel: rgba(255,255,255,.48);
      --panel-strong: rgba(255,255,255,.72);
      --panel-soft: rgba(255,255,255,.34);
      --border: rgba(255,255,255,.62);
      --accent: #1f87af;
      --accent-strong: #0f6e93;
      --input-bg: rgba(255,255,255,.58);
      --shadow: 0 24px 54px rgba(10, 26, 54, 0.18), inset 0 1px 0 rgba(255,255,255,.62);
      --glass-edge: rgba(255,255,255,.58);
      --glass-edge-soft: rgba(255,255,255,.34);
      --glass-highlight: rgba(255,255,255,.34);
      --glass-shadow: 0 18px 36px rgba(12, 28, 54, .16);
      --code-bg: rgba(8, 18, 34, .92);
      --code-fg: #e8f1ff;
      --code-border: rgba(141, 186, 236, .25);
      --brand-font: "Space Grotesk", "Avenir Next", "SF Pro Display", "Helvetica Neue", sans-serif;
      --assistant-width: 400px;
      color-scheme: light;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-0: #071225;
        --bg-1: #0f2238;
        --bg-2: #1a2f44;
        --text: #ebf3ff;
        --muted: #9db3cf;
        --panel: rgba(10, 18, 33, 0.52);
        --panel-strong: rgba(12, 21, 40, 0.74);
        --panel-soft: rgba(12, 23, 43, 0.36);
        --border: rgba(145, 183, 227, 0.33);
        --accent: #57c4df;
        --accent-strong: #3cacc7;
        --input-bg: rgba(21,34,56,.66);
        --shadow: 0 30px 66px rgba(2, 7, 16, 0.58), inset 0 1px 0 rgba(166,205,255,.16);
        --glass-edge: rgba(148, 189, 234, .34);
        --glass-edge-soft: rgba(148, 189, 234, .2);
        --glass-highlight: rgba(198, 223, 255, .16);
        --glass-shadow: 0 24px 44px rgba(3, 8, 17, .42);
        --code-bg: rgba(6, 16, 30, .94);
        --code-fg: #d8e8ff;
        --code-border: rgba(116, 171, 232, .26);
        color-scheme: dark;
      }
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      position: relative;
      background:
        radial-gradient(circle at 12% 12%, color-mix(in oklab, var(--accent) 20%, transparent), transparent 44%),
        radial-gradient(circle at 88% 5%, rgba(255, 155, 96, 0.16), transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(109, 196, 255, 0.2), transparent 45%),
        linear-gradient(155deg, var(--bg-0) 0%, var(--bg-1) 48%, var(--bg-2) 100%);
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    body::before {
      background:
        radial-gradient(circle at 20% 22%, rgba(255, 255, 255, .16), transparent 34%),
        radial-gradient(circle at 82% 18%, rgba(127, 206, 255, .15), transparent 36%);
      filter: blur(22px);
      opacity: .85;
    }

    body::after {
      background:
        linear-gradient(160deg, rgba(255,255,255,.08), transparent 36%),
        linear-gradient(332deg, rgba(255,255,255,.04), transparent 44%);
    }

    a { color: inherit; text-decoration: none; }

    .glass-strong {
      background:
        linear-gradient(145deg, color-mix(in oklab, var(--glass-highlight) 66%, transparent), transparent 42%),
        linear-gradient(328deg, color-mix(in oklab, var(--panel-strong) 88%, transparent), color-mix(in oklab, var(--panel) 76%, transparent));
      border: 1px solid var(--glass-edge);
      backdrop-filter: blur(22px) saturate(155%);
      -webkit-backdrop-filter: blur(22px) saturate(155%);
      box-shadow:
        var(--glass-shadow),
        inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 88%, transparent),
        inset 0 -1px 0 color-mix(in oklab, var(--glass-edge-soft) 70%, transparent);
    }

    .glass-soft {
      background:
        linear-gradient(150deg, color-mix(in oklab, var(--glass-highlight) 54%, transparent), transparent 52%),
        color-mix(in oklab, var(--panel-soft) 90%, transparent);
      border: 1px solid var(--glass-edge-soft);
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
      box-shadow:
        0 8px 18px color-mix(in oklab, var(--shadow) 28%, transparent),
        inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 72%, transparent);
    }

    .button {
      border: 1px solid color-mix(in oklab, var(--accent) 68%, white);
      color: #fff;
      background:
        linear-gradient(145deg, color-mix(in oklab, var(--accent) 82%, white) 0%, color-mix(in oklab, var(--accent-strong) 90%, black) 100%);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      box-shadow:
        0 12px 24px color-mix(in oklab, var(--accent) 30%, transparent),
        inset 0 1px 0 rgba(255,255,255,.26);
      border-radius: 10px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .button-ghost {
      border: 1px solid var(--glass-edge-soft);
      background:
        linear-gradient(155deg, color-mix(in oklab, var(--glass-highlight) 58%, transparent), transparent 60%),
        color-mix(in oklab, var(--panel-soft) 92%, transparent);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      box-shadow:
        inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 70%, transparent),
        0 6px 14px color-mix(in oklab, var(--shadow) 26%, transparent);
    }

    /* Liquid Glass Navigation */
    .liquid-glass-navigation {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }

    .liquid-nav {
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 40%, transparent), transparent 58%),
        color-mix(in oklab, var(--panel-soft) 82%, transparent);
      backdrop-filter: blur(18px) saturate(1.55);
      -webkit-backdrop-filter: blur(18px) saturate(1.55);
      border: 1px solid var(--glass-edge-soft);
      border-radius: 50px;
      padding: 8px;
      display: flex;
      gap: 4px;
      width: max-content;
      box-shadow:
        inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 82%, transparent),
        0 16px 30px color-mix(in oklab, var(--shadow) 34%, transparent);
    }

    .nav-item {
      padding: 8px 16px;
      border-radius: 50px;
      color: color-mix(in oklab, var(--text) 88%, white);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      border: 0;
      background: transparent;
      cursor: pointer;
      line-height: 1.1;
      font-family: inherit;
    }

    .nav-item:hover {
      background: color-mix(in oklab, var(--panel-strong) 88%, transparent);
      transform: translateY(-1px);
    }

    .nav-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: color-mix(in oklab, var(--glass-highlight) 72%, transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .nav-item:hover::before {
      opacity: 1;
    }

    .layout {
      height: 100dvh;
      max-width: 1900px;
      margin: 0 auto;
      padding: 10px;
      position: relative;
      z-index: 1;
    }

    .shell {
      height: 100%;
      display: grid;
      grid-template-columns: 300px minmax(0, 1fr) auto auto;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .sidebar {
      border-radius: 24px;
      padding: 12px;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar h1 {
      font-family: var(--brand-font);
      font-size: 28px;
      font-weight: 700;
      letter-spacing: .14em;
      text-transform: uppercase;
      margin: 8px 8px 4px;
      line-height: 1.15;
      color: var(--text);
      text-shadow: 0 8px 20px color-mix(in oklab, var(--accent) 24%, transparent);
    }

    .brand-link {
      display: inline-block;
      text-decoration: none;
      color: inherit;
      border-radius: 10px;
      padding: 2px 4px;
      outline: none;
    }

    .brand-link:focus-visible {
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 28%, transparent);
    }

    @supports ((background-clip: text) or (-webkit-background-clip: text)) {
      .sidebar h1 {
        background: linear-gradient(
          135deg,
          color-mix(in oklab, var(--accent) 78%, white) 0%,
          color-mix(in oklab, var(--text) 72%, var(--accent)) 60%,
          color-mix(in oklab, var(--accent-strong) 66%, var(--text)) 100%
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }
    }

    .search {
      border: 1px solid var(--glass-edge-soft);
      background:
        linear-gradient(145deg, color-mix(in oklab, var(--glass-highlight) 46%, transparent), transparent 56%),
        var(--input-bg);
      border-radius: 12px;
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      margin: 0 4px;
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      box-shadow: inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 70%, transparent);
    }

    .search input {
      border: 0;
      outline: 0;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      width: 100%;
    }

    #sidebar-list {
      min-height: 0;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 2px;
    }

    .chapter {
      border-radius: 14px;
      overflow: hidden;
    }

    .chapter-toggle {
      width: 100%;
      border: 1px solid color-mix(in oklab, var(--glass-edge-soft) 76%, transparent);
      background:
        linear-gradient(152deg, color-mix(in oklab, var(--glass-highlight) 44%, transparent), transparent 58%),
        color-mix(in oklab, var(--panel-soft) 72%, transparent);
      color: var(--text);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 10px 10px 12px;
      font-weight: 650;
      cursor: pointer;
      font-size: 13px;
      text-align: left;
      border-radius: 11px;
      transition: background 180ms ease, border-color 180ms ease, box-shadow 180ms ease;
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
    }

    .chapter-toggle:hover {
      background: color-mix(in oklab, var(--panel-strong) 85%, transparent);
      border-color: color-mix(in oklab, var(--accent) 28%, var(--border));
    }

    .chapter-toggle:focus-visible {
      outline: none;
      border-color: color-mix(in oklab, var(--accent) 65%, white);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 24%, transparent);
    }

    .chapter-toggle[aria-expanded="true"] {
      background: color-mix(in oklab, var(--panel-strong) 96%, transparent);
      border-color: color-mix(in oklab, var(--accent) 26%, var(--border));
    }

    .chapter-title {
      font-weight: 700;
      letter-spacing: .01em;
    }

    .chapter-arrow {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 8px;
      border: 1px solid color-mix(in oklab, var(--accent) 22%, var(--border));
      background:
        radial-gradient(circle at 30% 28%, color-mix(in oklab, var(--panel-strong) 78%, transparent), transparent 64%),
        color-mix(in oklab, var(--panel-soft) 68%, transparent);
      color: color-mix(in oklab, var(--accent) 62%, var(--text));
      transition:
        transform 180ms ease,
        color 180ms ease,
        background 180ms ease,
        border-color 180ms ease;
    }

    .chapter-arrow svg {
      width: 11px;
      height: 11px;
      display: block;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .chapter-arrow.expanded {
      transform: rotate(90deg);
      color: #fff;
      border-color: color-mix(in oklab, var(--accent) 66%, white);
      background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%);
    }

    .chapter-items {
      border-top: 1px solid var(--glass-edge-soft);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: color-mix(in oklab, var(--panel-soft) 48%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .nb-item {
      border: 1px solid transparent;
      border-radius: 10px;
      background: color-mix(in oklab, var(--panel-soft) 46%, transparent);
      text-align: left;
      color: var(--muted);
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 56%, transparent);
    }

    .nb-item:hover {
      background: color-mix(in oklab, var(--panel-strong) 88%, transparent);
      border-color: color-mix(in oklab, var(--glass-edge-soft) 74%, transparent);
      color: var(--text);
    }
    .nb-item.active {
      color: #fff;
      border-color: color-mix(in oklab, var(--accent) 68%, white);
      background: linear-gradient(145deg, color-mix(in oklab, var(--accent) 80%, white), color-mix(in oklab, var(--accent-strong) 88%, black));
      box-shadow: 0 10px 20px color-mix(in oklab, var(--accent) 30%, transparent);
    }

    .sidebar-footer {
      border-top: 1px solid var(--border);
      padding: 10px 8px 6px;
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .footer-link {
      display: block;
      text-align: center;
    }

    .main {
      min-width: 0;
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid var(--glass-edge-soft);
      padding: 10px 14px;
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--glass-highlight) 28%, transparent), transparent 42%),
        color-mix(in srgb, var(--panel-strong) 90%, transparent);
      backdrop-filter: blur(18px) saturate(150%);
      -webkit-backdrop-filter: blur(18px) saturate(150%);
      box-shadow: inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 54%, transparent);
    }

    .header-top {
      display: grid;
      grid-template-columns: 1fr minmax(0, auto) 1fr;
      align-items: center;
      gap: 12px;
    }

    .header-spacer {
      min-width: 0;
    }

    .header-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-actions {
      display: flex;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    #reader {
      min-height: 0;
      overflow: auto;
      padding: 12px;
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--glass-highlight) 18%, transparent), transparent 56%);
    }

    .selection-card {
      margin: 0 auto 10px;
      max-width: 980px;
      padding: 10px;
      border-radius: 12px;
      display: none;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
      font-size: 13px;
      background:
        linear-gradient(145deg, color-mix(in oklab, var(--glass-highlight) 48%, transparent), transparent 60%),
        color-mix(in oklab, var(--panel-soft) 84%, transparent);
      border: 1px solid var(--glass-edge-soft);
      backdrop-filter: blur(16px) saturate(138%);
      -webkit-backdrop-filter: blur(16px) saturate(138%);
    }

    .selection-title { font-weight: 700; margin-bottom: 4px; }
    .selection-text { color: var(--muted); max-height: 48px; overflow: hidden; white-space: pre-wrap; }

    #reader-card {
      max-width: 980px;
      margin: 0 auto;
      border-radius: 16px;
      padding: 16px 18px;
    }

    .reader-prose h1,
    .reader-prose h2,
    .reader-prose h3 { line-height: 1.25; margin-top: 1.4em; margin-bottom: .6em; }
    .reader-prose h1 { margin-top: .2em; font-size: 2rem; }
    .reader-prose h2 { font-size: 1.5rem; }
    .reader-prose p { line-height: 1.85; }
    .reader-prose pre {
      background:
        linear-gradient(156deg, rgba(255,255,255,.07), transparent 64%),
        var(--code-bg);
      color: var(--code-fg);
      border: 1px solid var(--code-border);
      border-radius: 12px;
      padding: 12px;
      overflow: auto;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
    }

    .home-hero {
      padding: 16px;
      border-radius: 14px;
      margin-bottom: 12px;
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 56%, transparent), transparent 50%),
        color-mix(in oklab, var(--panel-soft) 84%, transparent);
      border: 1px solid var(--glass-edge-soft);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .home-hero h3 {
      margin: 0 0 6px;
      font-size: 24px;
      line-height: 1.2;
    }

    .home-hero p {
      margin: 0;
      color: var(--muted);
      line-height: 1.75;
      font-size: 14px;
    }

    .home-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .home-card {
      border-radius: 12px;
      padding: 12px;
      font-size: 13px;
      background:
        linear-gradient(150deg, color-mix(in oklab, var(--glass-highlight) 48%, transparent), transparent 58%),
        color-mix(in oklab, var(--panel-soft) 82%, transparent);
      border: 1px solid var(--glass-edge-soft);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .home-card p {
      margin: 6px 0 0;
      color: var(--muted);
      line-height: 1.7;
    }

    .code-runner {
      margin: 1em 0;
      border: 1px solid var(--glass-edge-soft);
      border-radius: 12px;
      overflow: hidden;
      background:
        linear-gradient(145deg, color-mix(in oklab, var(--glass-highlight) 28%, transparent), transparent 64%),
        color-mix(in oklab, var(--panel-soft) 76%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .code-runner-shell {
      display: grid;
      grid-template-columns: 44px minmax(0, 1fr);
      align-items: stretch;
    }

    .code-runner-rail {
      border-right: 1px solid var(--border);
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 26%, transparent), transparent 70%),
        color-mix(in oklab, var(--panel-strong) 86%, transparent);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 8px;
    }

    .code-runner pre {
      margin: 0;
      border-radius: 0;
      border: 0;
      background:
        linear-gradient(156deg, rgba(255,255,255,.07), transparent 64%),
        var(--code-bg);
      color: var(--code-fg);
    }

    .run-code {
      width: 28px;
      height: 28px;
      border: 1px solid color-mix(in oklab, var(--accent) 28%, var(--border));
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 42%, transparent), transparent 64%),
        color-mix(in oklab, var(--panel-soft) 84%, transparent);
      color: var(--text);
      border-radius: 999px;
      padding: 0;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 140ms ease, border-color 140ms ease, color 140ms ease;
    }

    .run-code:hover {
      background: color-mix(in oklab, var(--panel-strong) 94%, transparent);
      border-color: color-mix(in oklab, var(--accent) 48%, var(--border));
    }

    .run-code:disabled {
      cursor: wait;
      opacity: .85;
    }

    .run-code .run-icon {
      width: 12px;
      height: 12px;
      display: block;
      fill: currentColor;
      transform: translateX(1px);
    }

    .run-code.is-running .run-icon {
      display: none;
    }

    .run-code .run-spinner {
      width: 12px;
      height: 12px;
      border: 2px solid color-mix(in oklab, var(--accent) 35%, transparent);
      border-top-color: currentColor;
      border-radius: 999px;
      display: none;
      animation: spin .8s linear infinite;
    }

    .run-code.is-running .run-spinner {
      display: block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .code-output {
      margin: 0;
      padding: 9px 10px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      white-space: pre-wrap;
      color: var(--text);
      background:
        linear-gradient(150deg, color-mix(in oklab, var(--glass-highlight) 32%, transparent), transparent 62%),
        color-mix(in oklab, var(--panel-soft) 90%, transparent);
      display: none;
    }

    .code-output.visible { display: block; }

    .resizer {
      width: 8px;
      border-radius: 8px;
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--glass-highlight) 44%, transparent), color-mix(in oklab, var(--panel-soft) 74%, transparent));
      border: 1px solid var(--glass-edge-soft);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor: col-resize;
      display: none;
    }

    .resizer.visible { display: block; }

    .assistant {
      width: var(--assistant-width);
      min-width: 320px;
      max-width: 700px;
      border-radius: 24px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .assistant.hidden { display: none; }

    .assistant-head {
      border: 1px solid var(--glass-edge-soft);
      border-radius: 14px;
      padding: 8px;
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 42%, transparent), transparent 58%),
        color-mix(in oklab, var(--panel-soft) 82%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .assistant-head-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .assistant-title { font-weight: 700; font-size: 24px; margin: 0; }

    #chat-log {
      min-height: 0;
      flex: 1;
      overflow: auto;
      border-radius: 14px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border: 1px solid var(--glass-edge-soft);
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 36%, transparent), transparent 62%),
        color-mix(in oklab, var(--panel-soft) 80%, transparent);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .msg {
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      line-height: 1.65;
      white-space: pre-wrap;
    }

    .msg.user { margin-left: 44px; background: color-mix(in oklab, var(--accent) 25%, transparent); }
    .msg.assistant {
      margin-right: 44px;
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 28%, transparent), transparent 66%),
        color-mix(in oklab, var(--panel-strong) 90%, transparent);
    }
    .msg.system { border: 1px solid var(--glass-edge-soft); background: color-mix(in oklab, var(--panel-soft) 86%, transparent); }
    .msg.user,
    .msg.assistant,
    .msg.system {
      border: 1px solid var(--glass-edge-soft);
      box-shadow: inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 60%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .msg-meta { color: var(--muted); font-size: 11px; margin-top: 6px; }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--glass-edge-soft);
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 36%, transparent), transparent 58%),
        color-mix(in oklab, var(--panel-soft) 80%, transparent);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
    }

    .control-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    select,
    textarea {
      border: 1px solid var(--glass-edge-soft);
      background:
        linear-gradient(150deg, color-mix(in oklab, var(--glass-highlight) 34%, transparent), transparent 60%),
        var(--input-bg);
      color: var(--text);
      border-radius: 10px;
      outline: 0;
      font-size: 13px;
      width: 100%;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 58%, transparent);
    }

    select { padding: 8px 10px; }
    textarea { min-height: 86px; padding: 10px; resize: none; }

    .fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 40;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 13px;
      display: none;
      border: 1px solid var(--glass-edge);
      background:
        linear-gradient(145deg, color-mix(in oklab, var(--accent) 78%, white), color-mix(in oklab, var(--accent-strong) 90%, black));
      backdrop-filter: blur(16px) saturate(145%);
      -webkit-backdrop-filter: blur(16px) saturate(145%);
      box-shadow: 0 14px 26px color-mix(in oklab, var(--accent) 30%, transparent), inset 0 1px 0 rgba(255,255,255,.26);
    }

    .fab.visible { display: inline-block; }

    .mobile-controls {
      display: none;
      border-bottom: 1px solid var(--glass-edge-soft);
      padding: 8px;
      justify-content: flex-start;
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--glass-highlight) 20%, transparent), transparent 58%),
        color-mix(in srgb, var(--panel-soft) 74%, transparent);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
    }

    .overlay {
      position: fixed;
      inset: 0;
      z-index: 50;
      background:
        radial-gradient(circle at 70% 30%, rgba(255,255,255,.08), transparent 46%),
        rgba(5, 8, 14, .44);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      padding: 10px;
      display: none;
    }

    .overlay.visible { display: block; }

    .overlay-panel {
      width: min(90vw, 360px);
      height: 100%;
      border-radius: 22px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 50%, transparent), transparent 58%),
        color-mix(in oklab, var(--panel-strong) 86%, transparent);
      border: 1px solid var(--glass-edge);
      backdrop-filter: blur(20px) saturate(150%);
      -webkit-backdrop-filter: blur(20px) saturate(150%);
      box-shadow: var(--glass-shadow), inset 0 1px 0 color-mix(in oklab, var(--glass-highlight) 72%, transparent);
    }

    .icon-muted {
      color: var(--muted);
    }

    .is-hidden {
      display: none;
    }

    .overlay-actions {
      display: flex;
      justify-content: flex-end;
    }

    .overlay-scroll {
      min-height: 0;
      overflow: auto;
    }

    .chat-mobile-mount {
      height: 100%;
    }

    .empty-note,
    .muted-empty,
    .error-text {
      margin: 0;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid var(--glass-edge-soft);
      background:
        linear-gradient(148deg, color-mix(in oklab, var(--glass-highlight) 36%, transparent), transparent 62%),
        color-mix(in oklab, var(--panel-soft) 76%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      font-size: 13px;
    }

    .muted-empty {
      color: var(--muted);
    }

    .error-text {
      color: #b5003c;
      border-color: color-mix(in oklab, #b5003c 46%, var(--glass-edge-soft));
      background:
        linear-gradient(148deg, rgba(255, 192, 209, .22), transparent 62%),
        color-mix(in oklab, var(--panel-soft) 78%, transparent);
    }

    @media (max-width: 960px) {
      .shell { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .resizer { display: none !important; }
      .assistant { display: none; }
      .mobile-controls { display: flex; }
      .header-top { grid-template-columns: 1fr; }
      .header-spacer { display: none; }
      .header-title { font-size: 16px; }
      .header-actions { justify-content: flex-start; }
      .home-grid { grid-template-columns: 1fr; }
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      .nav-item {
        padding: 8px 10px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <main class="layout">
    <div class="shell" id="shell">
      <aside class="sidebar glass-strong" id="sidebar-desktop">
        <h1><a class="brand-link" id="brand-home" href="/">Noema</a></h1>
        <label class="search">
          <span class="icon-muted">⌕</span>
          <input id="sidebar-search" placeholder="教材を検索" />
        </label>
        <div id="sidebar-list"></div>
        <div class="sidebar-footer">
          <a class="button" id="login-link" href="/login">ログイン</a>
          <a class="button-ghost is-hidden" id="admin-link" href="/admin.html">管理画面</a>
        </div>
      </aside>

      <section class="main glass-strong">
        <div class="mobile-controls">
          <div class="liquid-nav">
            <button class="nav-item" id="open-sidebar" type="button">教材メニュー</button>
            <button class="nav-item" id="open-chat-mobile" type="button">Assistant</button>
          </div>
        </div>

        <header class="header">
          <div class="header-top">
            <div class="header-spacer" aria-hidden="true"></div>
            <h2 class="header-title" id="header-title">読み込み中...</h2>
            <div class="header-actions">
              <div class="liquid-nav">
                <a class="nav-item" id="download-btn" href="#">Download</a>
                <a class="nav-item" id="colab-btn" href="#" target="_blank" rel="noreferrer">Colabで実行</a>
              </div>
            </div>
          </div>
        </header>

        <div id="reader">
          <div id="selection-card" class="selection-card glass-soft">
            <div>
              <div class="selection-title">選択中のテキストを質問に添付します</div>
              <div class="selection-text" id="selection-text"></div>
            </div>
            <button class="button-ghost" id="clear-selection" type="button">解除</button>
          </div>

          <div id="reader-card" class="glass-soft">
            <article class="reader-prose" id="notebook-content">教材を読み込み中...</article>
          </div>
        </div>
      </section>

      <div class="resizer" id="chat-resizer" aria-hidden="true"></div>

      <aside class="assistant glass-strong hidden" id="assistant-panel">
        <div class="assistant-head">
          <div class="assistant-head-top">
            <h3 class="assistant-title">Assistant</h3>
            <div class="liquid-nav">
              <button class="nav-item" id="new-chat" type="button">New</button>
              <button class="nav-item" id="chat-history" type="button">History</button>
            </div>
          </div>
        </div>

        <div id="chat-log" class="glass-soft"></div>

        <div class="controls">
          <select id="section-select" class="is-hidden"></select>
          <textarea id="chat-input" placeholder="ノート内容について質問する..."></textarea>
          <button class="button" id="send-chat" type="button">送信</button>
        </div>
      </aside>
    </div>
  </main>

  <button class="fab button" id="chat-fab" type="button">LLMに質問</button>

  <div class="overlay" id="sidebar-overlay">
    <div class="overlay-panel glass-strong">
      <div class="overlay-actions">
        <button class="button-ghost" id="close-sidebar" type="button">閉じる</button>
      </div>
      <div id="sidebar-mobile-list" class="overlay-scroll"></div>
      <a class="button" href="/login">ログイン</a>
      <a class="button-ghost footer-link is-hidden" id="admin-link-mobile" href="/admin.html">管理画面</a>
    </div>
  </div>

  <div class="overlay" id="chat-overlay">
    <div class="chat-mobile-mount" id="chat-mobile-mount"></div>
  </div>

  <script>
    (function () {
      const API_BASE = "https://52d3l83li2.execute-api.ap-northeast-3.amazonaws.com";
      const TOKEN_KEY = "noema_id_token";

      const state = {
        catalog: null,
        activeNotebook: null,
        openChapters: {},
        query: "",
        sectionIds: [],
        activeSection: "intro",
        selectedText: "",
        selectedSection: "",
        chatOpen: false,
        messages: [],
        busy: false,
        loggedIn: false,
        resizing: false,
        startX: 0,
        startWidth: 400
      };

      const el = {
        sidebarList: document.getElementById("sidebar-list"),
        sidebarMobileList: document.getElementById("sidebar-mobile-list"),
        sidebarSearch: document.getElementById("sidebar-search"),
        headerTitle: document.getElementById("header-title"),
        downloadBtn: document.getElementById("download-btn"),
        colabBtn: document.getElementById("colab-btn"),
        notebookContent: document.getElementById("notebook-content"),
        sectionSelect: document.getElementById("section-select"),
        chatLog: document.getElementById("chat-log"),
        chatInput: document.getElementById("chat-input"),
        sendChat: document.getElementById("send-chat"),
        assistantPanel: document.getElementById("assistant-panel"),
        chatFab: document.getElementById("chat-fab"),
        selectionCard: document.getElementById("selection-card"),
        selectionText: document.getElementById("selection-text"),
        clearSelection: document.getElementById("clear-selection"),
        brandHome: document.getElementById("brand-home"),
        loginLink: document.getElementById("login-link"),
        adminLink: document.getElementById("admin-link"),
        adminLinkMobile: document.getElementById("admin-link-mobile"),
        newChat: document.getElementById("new-chat"),
        chatHistory: document.getElementById("chat-history"),
        sidebarOverlay: document.getElementById("sidebar-overlay"),
        chatOverlay: document.getElementById("chat-overlay"),
        openSidebar: document.getElementById("open-sidebar"),
        closeSidebar: document.getElementById("close-sidebar"),
        openChatMobile: document.getElementById("open-chat-mobile"),
        chatMobileMount: document.getElementById("chat-mobile-mount"),
        resizer: document.getElementById("chat-resizer")
      };

      let highlightPromise = null;
      const preloadedNotebookPackages = new Set();

      function parseJwt(token) {
        try {
          const payload = token.split(".")[1];
          return JSON.parse(atob(payload.replace(/-/g, "+").replace(/_/g, "/")));
        } catch {
          return null;
        }
      }

      function getToken() {
        const token = localStorage.getItem(TOKEN_KEY) || "";
        if (!token) return "";
        const payload = parseJwt(token);
        if (!payload) return "";
        if (payload.exp && Date.now() >= payload.exp * 1000) {
          localStorage.removeItem(TOKEN_KEY);
          return "";
        }
        return token;
      }

      function updateAuthState() {
        const token = getToken();
        state.loggedIn = Boolean(token);

        if (state.loggedIn) {
          el.loginLink.textContent = "ログアウト";
          el.loginLink.href = "#";
          el.loginLink.onclick = function (event) {
            event.preventDefault();
            localStorage.removeItem(TOKEN_KEY);
            window.location.href = "/";
          };
          el.chatFab.classList.add("visible");
          el.adminLink.classList.remove("is-hidden");
          el.adminLinkMobile.classList.remove("is-hidden");
          if (state.activeNotebook) {
            void preloadNotebookPackages(el.notebookContent, state.activeNotebook.id);
          }
          return;
        }

        state.chatOpen = false;
        el.assistantPanel.classList.add("hidden");
        el.resizer.classList.remove("visible");
        el.chatFab.classList.remove("visible");
        el.adminLink.classList.add("is-hidden");
        el.adminLinkMobile.classList.add("is-hidden");
        preloadedNotebookPackages.clear();

        el.loginLink.textContent = "ログイン";
        el.loginLink.href = "/login";
        el.loginLink.onclick = null;
      }

      function notebookList() {
        const chapters = state.catalog?.chapters || [];
        return chapters
          .slice()
          .sort((a, b) => a.order - b.order)
          .map((chapter) => ({
            ...chapter,
            notebooks: chapter.notebooks.slice().sort((a, b) => a.order - b.order)
          }));
      }

      function matchNotebook(notebook, query) {
        if (!query) return true;
        const hay = `${notebook.title} ${notebook.id} ${(notebook.tags || []).join(" ")}`.toLowerCase();
        return hay.includes(query);
      }

      function buildSidebarHtml(forMobile) {
        const query = state.query.trim().toLowerCase();
        const chapters = notebookList()
          .map((chapter) => ({ ...chapter, notebooks: chapter.notebooks.filter((nb) => matchNotebook(nb, query)) }))
          .filter((chapter) => chapter.notebooks.length > 0);

        if (chapters.length === 0) {
          return '<p class="muted-empty">一致する教材がありません。</p>';
        }

        return chapters
          .map((chapter) => {
            const expanded = Boolean(state.openChapters[chapter.id]);
            const items = expanded
              ? `<div class="chapter-items">${chapter.notebooks
                  .map((nb) => {
                    const active = state.activeNotebook && state.activeNotebook.id === nb.id ? "active" : "";
                    return `<button class="nb-item ${active}" data-nb-id="${nb.id}" data-mobile="${forMobile ? "1" : "0"}">${nb.title}</button>`;
                  })
                  .join("")}</div>`
              : "";

            return `
              <section class="chapter glass-soft">
                <button class="chapter-toggle" data-chapter-id="${chapter.id}" data-mobile="${forMobile ? "1" : "0"}" type="button" aria-expanded="${expanded ? "true" : "false"}">
                  <span class="chapter-title">${chapter.title}</span>
                  <span class="chapter-arrow ${expanded ? "expanded" : ""}" aria-hidden="true">
                    <svg viewBox="0 0 12 12" focusable="false">
                      <path d="M4 2.25 L7.75 6 L4 9.75"></path>
                    </svg>
                  </span>
                </button>
                ${items}
              </section>
            `;
          })
          .join("");
      }

      function bindSidebar(container) {
        Array.from(container.querySelectorAll(".chapter-toggle")).forEach((button) => {
          button.addEventListener("click", function () {
            const id = button.getAttribute("data-chapter-id") || "";
            state.openChapters[id] = !state.openChapters[id];
            renderSidebar();
          });
        });

        Array.from(container.querySelectorAll(".nb-item")).forEach((button) => {
          button.addEventListener("click", function () {
            const id = button.getAttribute("data-nb-id") || "";
            if (id) {
              selectNotebook(id);
            }
            el.sidebarOverlay.classList.remove("visible");
          });
        });
      }

      function renderSidebar() {
        el.sidebarList.innerHTML = buildSidebarHtml(false);
        el.sidebarMobileList.innerHTML = buildSidebarHtml(true);
        bindSidebar(el.sidebarList);
        bindSidebar(el.sidebarMobileList);
      }

      function extractArticle(htmlText) {
        const doc = new DOMParser().parseFromString(htmlText, "text/html");
        const article = doc.querySelector("article") || doc.querySelector("main") || doc.body;
        return article ? article.innerHTML : htmlText;
      }

      function extractSectionIds(container) {
        const ids = [];
        container.querySelectorAll("h1[id], h2[id], h3[id], section[id], article[id]").forEach((node) => {
          if (node.id) ids.push(node.id);
        });
        return Array.from(new Set(ids));
      }

      function renderSections() {
        if (!state.activeNotebook) {
          el.sectionSelect.innerHTML = '<option value="intro">intro</option>';
          el.sectionSelect.value = "intro";
          el.sectionSelect.disabled = true;
          return;
        }

        const ids = state.sectionIds.length ? state.sectionIds : ["intro"];
        el.sectionSelect.innerHTML = ids.map((id) => `<option value="${id}">${id}</option>`).join("");
        if (!ids.includes(state.activeSection)) {
          state.activeSection = ids[0];
        }
        el.sectionSelect.value = state.activeSection;
        el.sectionSelect.disabled = false;
      }

      function renderHeader() {
        const nb = state.activeNotebook;
        if (!nb) {
          el.headerTitle.textContent = "教材トップ";
          el.downloadBtn.style.display = "none";
          el.colabBtn.style.display = "none";
          return;
        }

        el.downloadBtn.style.display = "";
        el.colabBtn.style.display = "";
        el.headerTitle.textContent = nb.title;
        el.downloadBtn.href = `/notebooks/${nb.id}.ipynb`;
        el.downloadBtn.setAttribute("download", `${nb.id}.ipynb`);
        el.colabBtn.href = nb.colabUrl || "#";
      }

      function renderHomeDashboard() {
        el.notebookContent.innerHTML = `
          <section class="home-hero glass-soft">
            <h3>学習サイトへようこそ</h3>
            <p>左のサイドバーから教材を選ぶと、ここにノート本文が表示されます。ログインすると右下からLLM質問機能も使えます。</p>
          </section>
          <section class="home-grid">
            <article class="home-card glass-soft">
              <strong>1. ノートを選択</strong>
              <p>章アコーディオンを開き、学習したい教材をクリックして読み始めてください。</p>
            </article>
            <article class="home-card glass-soft">
              <strong>2. コードをその場で実行</strong>
              <p>コードブロック右上の <code>Run</code> ボタンで、ページ内で Python を実行できます。</p>
            </article>
            <article class="home-card glass-soft">
              <strong>3. Colabで検証</strong>
              <p>上部の Colab ボタンから実運用に近い環境で再現できます。</p>
            </article>
            <article class="home-card glass-soft">
              <strong>4. LLMに質問</strong>
              <p>本文を選択して質問すると、選択箇所を文脈に含めて回答させられます。</p>
            </article>
          </section>
        `;
      }

      function extractImportedModulesFromSource(source) {
        const modules = new Set();
        const normalized = normalizeRunnableSource(source || "");
        const lines = normalized.split(/\r?\n/);

        lines.forEach((line) => {
          const trimmed = line.replace(/#.*/, "").trim();
          if (!trimmed) return;

          const importMatch = trimmed.match(/^import\s+(.+)$/);
          if (importMatch && importMatch[1]) {
            importMatch[1]
              .split(",")
              .map((part) => part.trim())
              .forEach((part) => {
                if (!part) return;
                const moduleName = part.split(/\s+as\s+/i)[0].trim().split(".")[0];
                if (moduleName) modules.add(moduleName);
              });
            return;
          }

          const fromMatch = trimmed.match(/^from\s+([A-Za-z0-9_.]+)\s+import\s+/);
          if (fromMatch && fromMatch[1]) {
            const moduleName = fromMatch[1].split(".")[0];
            if (moduleName) modules.add(moduleName);
          }
        });

        return Array.from(modules);
      }

      function collectNotebookImportedModules(container) {
        const modules = new Set();
        container.querySelectorAll("pre > code").forEach((code) => {
          extractImportedModulesFromSource(code.textContent || "").forEach((moduleName) => {
            modules.add(moduleName);
          });
        });
        return Array.from(modules);
      }

      function normalizeModuleHints(moduleNames) {
        const hints = new Set();
        moduleNames.forEach((moduleName) => {
          const normalized = (moduleName || "").split(".")[0].trim();
          if (!/^[A-Za-z_][A-Za-z0-9_]*$/.test(normalized)) return;
          hints.add(normalized);
        });
        return Array.from(hints).slice(0, 24);
      }

      async function preloadNotebookPackages(container, notebookId) {
        if (!state.loggedIn) return;
        const token = getToken();
        if (!token) return;

        const modules = normalizeModuleHints(collectNotebookImportedModules(container));
        const preloadKey = `${notebookId}:${modules.join(",")}`;
        if (preloadedNotebookPackages.has(preloadKey)) return;

        preloadedNotebookPackages.add(preloadKey);
        try {
          await fetch(`${API_BASE}/api/runtime/python/preload`, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({
              notebookId,
              expectedModules: modules
            })
          });
        } catch (error) {
          preloadedNotebookPackages.delete(preloadKey);
          console.warn("Runtime preload failed", notebookId, error);
        }
      }

      async function runPythonOnServer(source, notebookId, sectionId, expectedModules) {
        const token = getToken();
        if (!token) {
          throw new Error("コード実行にはログインが必要です。");
        }

        const response = await fetch(`${API_BASE}/api/runtime/python`, {
          method: "POST",
          headers: {
            "content-type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            notebookId,
            sectionId,
            code: source,
            expectedModules: normalizeModuleHints(expectedModules)
          })
        });

        let payload = {};
        try {
          payload = await response.json();
        } catch {
          payload = {};
        }

        if (!response.ok) {
          const errorText = payload && typeof payload.error === "string" ? payload.error : "Python実行に失敗しました。";
          throw new Error(errorText);
        }

        return payload;
      }

      function renderPythonRunOutput(payload) {
        const stdout = payload && typeof payload.stdout === "string" ? payload.stdout.trim() : "";
        const stderr = payload && typeof payload.stderr === "string" ? payload.stderr.trim() : "";
        const errorText = payload && typeof payload.error === "string" ? payload.error.trim() : "";
        const durationMs = payload && Number.isFinite(Number(payload.durationMs)) ? Number(payload.durationMs) : 0;
        const installedPackages = Array.isArray(payload?.installedPackages)
          ? payload.installedPackages.map((pkg) => String(pkg).trim()).filter(Boolean)
          : [];

        const lines = [];
        if (stdout) lines.push(stdout);
        if (stderr) lines.push(stderr);
        if (errorText) lines.push(`Error: ${errorText}`);
        if (installedPackages.length) lines.push(`[installed] ${installedPackages.join(", ")}`);
        lines.push(`[runtime] AWS Python ${durationMs}ms`);
        return lines.join("\n") || "(no output)";
      }

      function ensureHighlightLibrary() {
        if (window.hljs) return Promise.resolve(window.hljs);
        if (!highlightPromise) {
          highlightPromise = new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = "/highlight/highlight.min.js";
            script.async = true;
            script.onload = () => resolve(window.hljs);
            script.onerror = () => reject(new Error("Highlight.js load failed"));
            document.head.appendChild(script);
          });
        }
        return highlightPromise;
      }

      async function applySyntaxHighlight(container) {
        const blocks = container.querySelectorAll("pre > code");
        if (!blocks.length) return;
        try {
          const hljs = await ensureHighlightLibrary();
          if (!hljs) return;
          blocks.forEach((block) => {
            if (!block.className.includes("language-")) {
              block.classList.add("language-python");
            }
            hljs.highlightElement(block);
          });
        } catch {}
      }

      function normalizeRunnableSource(rawSource) {
        if (!rawSource) return "";
        // nbconvertの出力によっては改行が "\n" の2文字で入るため、実行前に正規化する。
        if (!rawSource.includes("\n") && /\\[nrt]/.test(rawSource)) {
          return rawSource
            .replace(/\\r/g, "\r")
            .replace(/\\n/g, "\n")
            .replace(/\\t/g, "\t");
        }
        return rawSource;
      }

      function enhanceCodeBlocks() {
        const blocks = el.notebookContent.querySelectorAll("pre > code");

        blocks.forEach((code) => {
          const pre = code.parentElement;
          if (!pre || pre.dataset.noemaRunnable === "1") return;
          pre.dataset.noemaRunnable = "1";

          const wrapper = document.createElement("div");
          wrapper.className = "code-runner";
          pre.parentNode.insertBefore(wrapper, pre);
          const shell = document.createElement("div");
          shell.className = "code-runner-shell";
          wrapper.appendChild(shell);

          const rail = document.createElement("div");
          rail.className = "code-runner-rail";
          shell.appendChild(rail);

          shell.appendChild(pre);

          const button = document.createElement("button");
          button.className = "run-code";
          button.type = "button";
          button.setAttribute("aria-label", "Run code");
          button.setAttribute("title", "Run");
          button.innerHTML = '<svg class="run-icon" viewBox="0 0 12 12" aria-hidden="true"><path d="M3 2.2L10 6 3 9.8V2.2Z"></path></svg><span class="run-spinner" aria-hidden="true"></span>';
          rail.appendChild(button);

          const output = document.createElement("pre");
          output.className = "code-output";
          wrapper.appendChild(output);

          button.addEventListener("click", async () => {
            const source = normalizeRunnableSource(code.textContent || "");
            if (!source.trim()) return;

            button.disabled = true;
            button.classList.add("is-running");
            output.classList.add("visible");
            output.textContent = "AWS Python runtime executing...";

            try {
              const expectedModules = extractImportedModulesFromSource(source);
              const payload = await runPythonOnServer(
                source,
                (state.activeNotebook && state.activeNotebook.id) || "unknown-notebook",
                state.activeSection || "intro",
                expectedModules
              );
              output.textContent = renderPythonRunOutput(payload);
            } catch (error) {
              output.textContent = `Error: ${error instanceof Error ? error.message : String(error)}`;
            } finally {
              button.disabled = false;
              button.classList.remove("is-running");
            }
          });
        });
      }

      async function selectNotebook(notebookId) {
        const chapters = notebookList();
        let target = null;
        let chapterId = "";

        for (const chapter of chapters) {
          const found = chapter.notebooks.find((nb) => nb.id === notebookId);
          if (found) {
            target = found;
            chapterId = chapter.id;
            break;
          }
        }

        if (!target) return;

        state.activeNotebook = target;
        if (chapterId) {
          state.openChapters[chapterId] = true;
        }
        state.selectedText = "";
        state.selectedSection = "";
        state.sectionIds = ["intro"];

        renderSidebar();
        renderHeader();
        renderSelectionCard();
        el.notebookContent.innerHTML = "教材を読み込み中...";

        try {
          const response = await fetch(target.htmlPath, { cache: "no-cache" });
          if (!response.ok) throw new Error("教材HTMLの読み込みに失敗しました");
          const htmlText = await response.text();
          el.notebookContent.innerHTML = extractArticle(htmlText);
          el.notebookContent.classList.add("reader-prose");
          state.sectionIds = extractSectionIds(el.notebookContent);
          state.activeSection = state.sectionIds[0] || "intro";
          renderHeader();
          renderSections();
          void preloadNotebookPackages(el.notebookContent, target.id);
          await applySyntaxHighlight(el.notebookContent);
          enhanceCodeBlocks();

          const url = new URL(window.location.href);
          url.searchParams.set("notebookId", target.id);
          window.history.replaceState(null, "", url.toString());
        } catch (error) {
          const msg = error instanceof Error ? error.message : "読み込みエラー";
          el.notebookContent.innerHTML = `<p class=\"error-text\">${msg}</p>`;
        }
      }

      function captureSelection() {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return null;

        const text = selection.toString().trim();
        if (!text) return null;

        const range = selection.getRangeAt(0);
        if (!el.notebookContent.contains(range.startContainer) || !el.notebookContent.contains(range.endContainer)) {
          return null;
        }

        let node = range.startContainer.nodeType === Node.ELEMENT_NODE ? range.startContainer : range.startContainer.parentElement;
        while (node && node !== el.notebookContent) {
          if (node.id) {
            return { text, sectionId: node.id };
          }
          node = node.parentElement;
        }

        return { text, sectionId: "" };
      }

      function renderSelectionCard() {
        if (!state.selectedText) {
          el.selectionCard.style.display = "none";
          el.selectionText.textContent = "";
          return;
        }

        el.selectionCard.style.display = "flex";
        el.selectionText.textContent = state.selectedText;
      }

      function pushMessage(role, text, meta) {
        state.messages.push({ role, text, meta: meta || {} });
        renderMessages();
      }

      function renderMessages() {
        if (!state.messages.length) {
          el.chatLog.innerHTML = '<p class="muted-empty">質問を入力して送信してください。</p>';
          return;
        }

        el.chatLog.innerHTML = state.messages
          .map((message) => {
            const refs = message.meta && message.meta.refs ? `<div class=\"msg-meta\">参照: ${message.meta.refs}</div>` : "";
            return `<article class=\"msg ${message.role}\">${escapeHtml(message.text)}${refs}</article>`;
          })
          .join("");
        el.chatLog.scrollTop = el.chatLog.scrollHeight;
      }

      function escapeHtml(value) {
        return value
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;")
          .replace(/\n/g, "<br>");
      }

      async function pollAnswer(questionId, token) {
        for (let i = 0; i < 25; i += 1) {
          const response = await fetch(`${API_BASE}/api/questions/${encodeURIComponent(questionId)}/answer`, {
            headers: { Authorization: `Bearer ${token}` }
          });

          if (response.status === 202) {
            await new Promise((resolve) => setTimeout(resolve, 1200));
            continue;
          }

          if (!response.ok) {
            let error = "回答の取得に失敗しました";
            try {
              const payload = await response.json();
              if (payload && payload.error) error = payload.error;
            } catch {}
            throw new Error(error);
          }

          return response.json();
        }

        throw new Error("回答待機がタイムアウトしました");
      }

      async function sendQuestion() {
        if (state.busy || !state.loggedIn) return;

        const text = el.chatInput.value.trim();
        if (!text) return;

        const notebook = state.activeNotebook;
        if (!notebook) {
          pushMessage("system", "先にサイドバーから教材を選択してください。");
          return;
        }

        const token = getToken();
        if (!token) {
          pushMessage("system", "セッションが切れています。再ログインしてください。");
          setChatOpen(false);
          updateAuthState();
          return;
        }

        const selection = captureSelection();
        if (selection) {
          state.selectedText = selection.text;
          state.selectedSection = selection.sectionId || "";
          renderSelectionCard();
        }

        const sectionId = state.selectedSection || state.activeSection || "intro";
        const questionText = state.selectedText ? `${text}\n\n[Selection]\n${state.selectedText}` : text;

        pushMessage("user", text);
        el.chatInput.value = "";
        state.busy = true;
        el.sendChat.disabled = true;
        el.sendChat.textContent = "回答生成中...";

        try {
          const response = await fetch(`${API_BASE}/api/questions`, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({
              notebookId: notebook.id,
              sectionId,
              questionText
            })
          });

          if (!response.ok) {
            let error = "質問の送信に失敗しました";
            try {
              const payload = await response.json();
              if (payload && payload.error) error = payload.error;
            } catch {}
            throw new Error(error);
          }

          const payload = await response.json();
          const answer = await pollAnswer(payload.questionId, token);
          const refs = (answer.sourceReferences || []).map((source) => `${source.notebookId}${source.location}`).join(", ");
          pushMessage("assistant", answer.answerText || "回答が空でした", { refs });
        } catch (error) {
          pushMessage("system", error instanceof Error ? error.message : "質問処理に失敗しました");
        } finally {
          state.busy = false;
          el.sendChat.disabled = false;
          el.sendChat.textContent = "送信";
        }
      }

      async function loadQuestionHistory() {
        if (!state.loggedIn) {
          window.location.href = "/login";
          return;
        }

        const notebook = state.activeNotebook;
        if (!notebook) {
          pushMessage("system", "先にサイドバーから教材を選択してください。");
          return;
        }

        const token = getToken();
        if (!token) {
          pushMessage("system", "セッションが切れています。再ログインしてください。");
          setChatOpen(false);
          updateAuthState();
          return;
        }

        el.chatHistory.disabled = true;
        const before = el.chatHistory.textContent;
        el.chatHistory.textContent = "Loading...";

        try {
          const response = await fetch(
            `${API_BASE}/api/questions/history?notebookId=${encodeURIComponent(notebook.id)}`,
            { headers: { Authorization: `Bearer ${token}` } }
          );

          if (!response.ok) {
            let error = "履歴の取得に失敗しました";
            try {
              const payload = await response.json();
              if (payload && payload.error) error = payload.error;
            } catch {}
            throw new Error(error);
          }

          const payload = await response.json();
          const items = Array.isArray(payload?.items) ? payload.items : [];

          if (!items.length) {
            state.messages = [ { role: "system", text: "このノートの履歴はまだありません。", meta: {} } ];
            renderMessages();
            return;
          }

          const sorted = items
            .slice()
            .sort((a, b) => String(a.createdAt || "").localeCompare(String(b.createdAt || "")));

          state.messages = [];
          sorted.forEach((item) => {
            if (item.questionText) {
              state.messages.push({ role: "user", text: String(item.questionText), meta: {} });
            }
            if (item.answerText) {
              const refs = Array.isArray(item.sourceReferences)
                ? item.sourceReferences.map((source) => `${source.notebookId || ""}${source.location || ""}`).join(", ")
                : "";
              state.messages.push({ role: "assistant", text: String(item.answerText), meta: refs ? { refs } : {} });
            }
          });
          renderMessages();
        } catch (error) {
          pushMessage("system", error instanceof Error ? error.message : "履歴の取得に失敗しました");
        } finally {
          el.chatHistory.disabled = false;
          el.chatHistory.textContent = before || "History";
        }
      }

      function setChatOpen(open) {
        if (open && !state.loggedIn) {
          window.location.href = "/login";
          return;
        }

        state.chatOpen = open;
        el.assistantPanel.classList.toggle("hidden", !open);
        el.resizer.classList.toggle("visible", open && window.innerWidth > 960);
        el.chatFab.classList.toggle("visible", !open && state.loggedIn);
      }

      function startResize(event) {
        if (window.innerWidth <= 960 || !state.chatOpen) return;
        state.resizing = true;
        state.startX = event.clientX;
        state.startWidth = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--assistant-width")) || 400;
        document.body.style.userSelect = "none";
      }

      function onResize(event) {
        if (!state.resizing) return;
        const diff = state.startX - event.clientX;
        const next = Math.max(320, Math.min(700, state.startWidth + diff));
        document.documentElement.style.setProperty("--assistant-width", `${next}px`);
      }

      function stopResize() {
        if (!state.resizing) return;
        state.resizing = false;
        document.body.style.userSelect = "";
      }

      async function loadCatalog() {
        const apiResponse = await fetch(`${API_BASE}/api/catalog`, { cache: "no-cache" }).catch(() => null);
        if (apiResponse && apiResponse.ok) {
          return apiResponse.json();
        }

        const response = await fetch("/catalog.json", { cache: "no-cache" });
        if (!response.ok) {
          throw new Error("catalog の読み込みに失敗しました");
        }
        return response.json();
      }

      function findInitialNotebookId() {
        const q = new URLSearchParams(window.location.search);
        return q.get("notebookId") || "";
      }

      function showHomeDashboard() {
        state.activeNotebook = null;
        state.sectionIds = [];
        state.activeSection = "intro";
        state.selectedText = "";
        state.selectedSection = "";
        renderSidebar();
        renderHeader();
        renderSections();
        renderSelectionCard();
        renderHomeDashboard();
        const url = new URL(window.location.href);
        url.searchParams.delete("notebookId");
        window.history.replaceState(null, "", url.toString());
      }

      async function init() {
        updateAuthState();
        renderMessages();

        try {
          state.catalog = await loadCatalog();
        } catch (error) {
          el.notebookContent.innerHTML = `<p class=\"error-text\">${error instanceof Error ? error.message : "初期化エラー"}</p>`;
          return;
        }

        const chapters = notebookList();
        const notebooks = chapters.flatMap((chapter) => chapter.notebooks);
        if (!notebooks.length) {
          el.notebookContent.innerHTML = '<p class="empty-note">教材がありません。</p>';
          return;
        }

        const requested = findInitialNotebookId();
        const requestedNotebook = notebooks.find((nb) => nb.id === requested) || null;

        state.openChapters = {};
        renderSidebar();
        if (requestedNotebook) {
          await selectNotebook(requestedNotebook.id);
        } else {
          showHomeDashboard();
        }
      }

      el.sidebarSearch.addEventListener("input", function (event) {
        state.query = event.target.value || "";
        renderSidebar();
      });

      el.brandHome.addEventListener("click", function (event) {
        event.preventDefault();
        showHomeDashboard();
      });

      el.sectionSelect.addEventListener("change", function () {
        state.activeSection = el.sectionSelect.value;
      });

      el.sendChat.addEventListener("click", function () {
        void sendQuestion();
      });

      el.chatInput.addEventListener("keydown", function (event) {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          event.preventDefault();
          void sendQuestion();
        }
      });

      el.clearSelection.addEventListener("click", function () {
        state.selectedText = "";
        state.selectedSection = "";
        renderSelectionCard();
      });

      el.newChat.addEventListener("click", function () {
        state.messages = [];
        renderMessages();
      });

      el.chatHistory.addEventListener("click", function () {
        void loadQuestionHistory();
      });

      el.chatFab.addEventListener("click", function () {
        setChatOpen(true);
      });

      el.openSidebar.addEventListener("click", function () {
        el.sidebarOverlay.classList.add("visible");
      });

      el.closeSidebar.addEventListener("click", function () {
        el.sidebarOverlay.classList.remove("visible");
      });

      el.openChatMobile.addEventListener("click", function () {
        if (!state.loggedIn) {
          window.location.href = "/login";
          return;
        }
        setChatOpen(true);
        el.chatOverlay.classList.add("visible");
        el.chatMobileMount.innerHTML = "";
        el.chatMobileMount.appendChild(el.assistantPanel);
        el.assistantPanel.style.display = "flex";
      });

      el.sidebarOverlay.addEventListener("click", function (event) {
        if (event.target === el.sidebarOverlay) {
          el.sidebarOverlay.classList.remove("visible");
        }
      });

      el.chatOverlay.addEventListener("click", function (event) {
        if (event.target === el.chatOverlay) {
          el.chatOverlay.classList.remove("visible");
          if (window.innerWidth <= 960) {
            document.getElementById("shell").appendChild(el.assistantPanel);
          }
        }
      });

      el.resizer.addEventListener("mousedown", startResize);
      window.addEventListener("mousemove", onResize);
      window.addEventListener("mouseup", stopResize);
      window.addEventListener("mouseleave", stopResize);

      window.addEventListener("resize", function () {
        if (window.innerWidth <= 960) {
          el.resizer.classList.remove("visible");
        } else if (state.chatOpen) {
          el.resizer.classList.add("visible");
          if (el.assistantPanel.parentElement !== document.getElementById("shell")) {
            document.getElementById("shell").appendChild(el.assistantPanel);
          }
          el.chatOverlay.classList.remove("visible");
        }
      });

      void init();
    })();
  </script>
</body>
</html>
