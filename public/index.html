<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noema</title>
  <style>
    :root {
      --bg-0: #f3f8fb;
      --bg-1: #d7e8f4;
      --bg-2: #f9f1e7;
      --text: #09162b;
      --muted: #44556f;
      --panel: rgba(255,255,255,.48);
      --panel-strong: rgba(255,255,255,.72);
      --panel-soft: rgba(255,255,255,.34);
      --border: rgba(255,255,255,.62);
      --accent: #1f87af;
      --accent-strong: #0f6e93;
      --input-bg: rgba(255,255,255,.58);
      --shadow: 0 24px 54px rgba(10, 26, 54, 0.18), inset 0 1px 0 rgba(255,255,255,.62);
      --assistant-width: 400px;
      color-scheme: light;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-0: #071225;
        --bg-1: #0f2238;
        --bg-2: #1a2f44;
        --text: #ebf3ff;
        --muted: #9db3cf;
        --panel: rgba(10, 18, 33, 0.52);
        --panel-strong: rgba(12, 21, 40, 0.74);
        --panel-soft: rgba(12, 23, 43, 0.36);
        --border: rgba(145, 183, 227, 0.33);
        --accent: #57c4df;
        --accent-strong: #3cacc7;
        --input-bg: rgba(21,34,56,.66);
        --shadow: 0 30px 66px rgba(2, 7, 16, 0.58), inset 0 1px 0 rgba(166,205,255,.16);
        color-scheme: dark;
      }
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      background:
        radial-gradient(circle at 12% 12%, color-mix(in oklab, var(--accent) 20%, transparent), transparent 44%),
        radial-gradient(circle at 88% 5%, rgba(255, 155, 96, 0.16), transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(109, 196, 255, 0.2), transparent 45%),
        linear-gradient(155deg, var(--bg-0) 0%, var(--bg-1) 48%, var(--bg-2) 100%);
    }

    a { color: inherit; text-decoration: none; }

    .glass-strong {
      background: var(--panel-strong);
      border: 1px solid var(--border);
      backdrop-filter: blur(20px) saturate(145%);
      -webkit-backdrop-filter: blur(20px) saturate(145%);
      box-shadow: var(--shadow);
    }

    .glass-soft {
      background: var(--panel-soft);
      border: 1px solid var(--border);
      backdrop-filter: blur(14px) saturate(125%);
      -webkit-backdrop-filter: blur(14px) saturate(125%);
    }

    .button {
      border: 1px solid color-mix(in oklab, var(--accent) 64%, white);
      color: #fff;
      background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%);
      box-shadow: 0 10px 24px color-mix(in oklab, var(--accent) 30%, transparent);
      border-radius: 10px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .button-ghost {
      border: 1px solid var(--border);
      background: var(--panel-soft);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    .layout {
      height: 100dvh;
      max-width: 1900px;
      margin: 0 auto;
      padding: 10px;
    }

    .shell {
      height: 100%;
      display: grid;
      grid-template-columns: 300px minmax(0, 1fr) auto auto;
      gap: 10px;
    }

    .sidebar {
      border-radius: 24px;
      padding: 12px;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-title {
      letter-spacing: .2em;
      color: var(--accent);
      text-transform: uppercase;
      font-size: 11px;
      margin: 4px 8px 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    .sidebar h1 {
      font-size: 32px;
      margin: 2px 8px 4px;
      line-height: 1.15;
    }

    .search {
      border: 1px solid var(--border);
      background: var(--input-bg);
      border-radius: 12px;
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      margin: 0 4px;
    }

    .search input {
      border: 0;
      outline: 0;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      width: 100%;
    }

    #sidebar-list {
      min-height: 0;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 2px;
    }

    .chapter {
      border-radius: 14px;
      overflow: hidden;
    }

    .chapter-toggle {
      width: 100%;
      border: 0;
      background: transparent;
      color: var(--text);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
      font-size: 13px;
      text-align: left;
    }

    .chapter-items {
      border-top: 1px solid var(--border);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nb-item {
      border: 0;
      border-radius: 10px;
      background: transparent;
      text-align: left;
      color: var(--muted);
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
    }

    .nb-item:hover { background: var(--panel-strong); color: var(--text); }
    .nb-item.active { color: #fff; background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%); }

    .sidebar-footer {
      border-top: 1px solid var(--border);
      padding: 10px 8px 6px;
      margin-top: auto;
    }

    .main {
      min-width: 0;
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .header {
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid var(--border);
      padding: 10px 14px;
      background: color-mix(in srgb, var(--panel-strong) 94%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .header-top {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 12px;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    #reader {
      min-height: 0;
      overflow: auto;
      padding: 12px;
    }

    .selection-card {
      margin: 0 auto 10px;
      max-width: 980px;
      padding: 10px;
      border-radius: 12px;
      display: none;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
      font-size: 13px;
    }

    .selection-title { font-weight: 700; margin-bottom: 4px; }
    .selection-text { color: var(--muted); max-height: 48px; overflow: hidden; white-space: pre-wrap; }

    #reader-card {
      max-width: 980px;
      margin: 0 auto;
      border-radius: 16px;
      padding: 16px 18px;
    }

    .reader-prose h1,
    .reader-prose h2,
    .reader-prose h3 { line-height: 1.25; margin-top: 1.4em; margin-bottom: .6em; }
    .reader-prose h1 { margin-top: .2em; font-size: 2rem; }
    .reader-prose h2 { font-size: 1.5rem; }
    .reader-prose p { line-height: 1.85; }
    .reader-prose pre {
      background: #081220;
      color: #e8f1ff;
      border-radius: 12px;
      padding: 12px;
      overflow: auto;
    }

    .resizer {
      width: 8px;
      border-radius: 8px;
      background: color-mix(in oklab, var(--panel-soft) 70%, transparent);
      cursor: col-resize;
      display: none;
    }

    .resizer.visible { display: block; }

    .assistant {
      width: var(--assistant-width);
      min-width: 320px;
      max-width: 700px;
      border-radius: 24px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .assistant.hidden { display: none; }

    .assistant-head {
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    .assistant-head-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .assistant-title { font-weight: 700; font-size: 24px; margin: 0; }

    .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .card { border-radius: 12px; padding: 10px; font-size: 13px; }
    .card p { margin: 4px 0 0; color: var(--muted); }

    #chat-log {
      min-height: 0;
      flex: 1;
      overflow: auto;
      border-radius: 14px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg {
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      line-height: 1.65;
      white-space: pre-wrap;
    }

    .msg.user { margin-left: 44px; background: color-mix(in oklab, var(--accent) 25%, transparent); }
    .msg.assistant { margin-right: 44px; background: var(--panel-strong); }
    .msg.system { border: 1px solid var(--border); background: var(--panel-soft); }
    .msg-meta { color: var(--muted); font-size: 11px; margin-top: 6px; }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    select,
    textarea {
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      border-radius: 10px;
      outline: 0;
      font-size: 13px;
      width: 100%;
    }

    select { padding: 8px 10px; }
    textarea { min-height: 86px; padding: 10px; resize: vertical; }

    .fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 40;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 13px;
      display: none;
    }

    .fab.visible { display: inline-block; }

    .mobile-controls {
      display: none;
      border-bottom: 1px solid var(--border);
      padding: 8px;
      gap: 8px;
    }

    .overlay {
      position: fixed;
      inset: 0;
      z-index: 50;
      background: rgba(5, 8, 14, .4);
      padding: 10px;
      display: none;
    }

    .overlay.visible { display: block; }

    .overlay-panel {
      width: min(90vw, 360px);
      height: 100%;
      border-radius: 22px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (max-width: 960px) {
      .shell { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .resizer { display: none !important; }
      .assistant { display: none; }
      .mobile-controls { display: flex; }
      .header-top { grid-template-columns: 1fr; }
      .header-title { font-size: 18px; }
      .header-actions { justify-content: flex-start; }
    }
  </style>
</head>
<body>
  <main class="layout">
    <div class="shell" id="shell">
      <aside class="sidebar glass-strong" id="sidebar-desktop">
        <p class="sidebar-title">Noema</p>
        <h1>機械学習ノート</h1>
        <label class="search">
          <span style="color:var(--muted)">⌕</span>
          <input id="sidebar-search" placeholder="教材を検索" />
        </label>
        <div id="sidebar-list"></div>
        <div class="sidebar-footer">
          <a class="button" id="login-link" href="/login">ログイン</a>
        </div>
      </aside>

      <section class="main glass-strong">
        <div class="mobile-controls">
          <button class="button-ghost" id="open-sidebar" type="button">教材メニュー</button>
          <button class="button-ghost" id="open-chat-mobile" type="button">Assistant</button>
        </div>

        <header class="header">
          <div class="header-top">
            <h2 class="header-title" id="header-title">読み込み中...</h2>
            <div class="header-actions">
              <a class="button-ghost" id="download-btn" href="#">Download</a>
              <a class="button" id="colab-btn" href="#" target="_blank" rel="noreferrer">Colabで実行</a>
              <a class="button-ghost" id="jupyterlite-btn" href="#" target="_blank" rel="noreferrer">JupyterLite</a>
            </div>
          </div>
        </header>

        <div id="reader">
          <div id="selection-card" class="selection-card glass-soft">
            <div>
              <div class="selection-title">選択中のテキストを質問に添付します</div>
              <div class="selection-text" id="selection-text"></div>
            </div>
            <button class="button-ghost" id="clear-selection" type="button">解除</button>
          </div>

          <div id="reader-card" class="glass-soft">
            <article class="reader-prose" id="notebook-content">教材を読み込み中...</article>
          </div>
        </div>
      </section>

      <div class="resizer" id="chat-resizer" aria-hidden="true"></div>

      <aside class="assistant glass-strong hidden" id="assistant-panel">
        <div class="assistant-head">
          <div class="assistant-head-top">
            <h3 class="assistant-title">Assistant</h3>
            <div style="display:flex; gap:6px;">
              <button class="button-ghost" id="new-chat" type="button">New</button>
            </div>
          </div>
          <div class="cards">
            <div class="card glass-soft">
              <strong>Highlight & Ask</strong>
              <p>本文選択 + 質問で選択範囲を優先解説します。</p>
            </div>
            <div class="card glass-soft">
              <strong>Add Context</strong>
              <p>セクション指定で関連チャンクを絞って回答します。</p>
            </div>
          </div>
        </div>

        <div id="chat-log" class="glass-soft"></div>

        <div class="controls">
          <div class="control-row">
            <select id="section-select"></select>
            <button class="button-ghost" id="pick-selection" type="button">selection</button>
          </div>
          <textarea id="chat-input" placeholder="ノート内容について質問する..."></textarea>
          <button class="button" id="send-chat" type="button">送信</button>
        </div>
      </aside>
    </div>
  </main>

  <button class="fab button" id="chat-fab" type="button">LLMに質問</button>

  <div class="overlay" id="sidebar-overlay">
    <div class="overlay-panel glass-strong">
      <div style="display:flex; justify-content:flex-end;">
        <button class="button-ghost" id="close-sidebar" type="button">閉じる</button>
      </div>
      <div id="sidebar-mobile-list" style="min-height:0; overflow:auto;"></div>
      <a class="button" href="/login">ログイン</a>
    </div>
  </div>

  <div class="overlay" id="chat-overlay">
    <div style="height:100%;" id="chat-mobile-mount"></div>
  </div>

  <script>
    (function () {
      const API_BASE = "https://52d3l83li2.execute-api.ap-northeast-3.amazonaws.com";
      const TOKEN_KEY = "noema_id_token";

      const state = {
        catalog: null,
        activeNotebook: null,
        openChapter: null,
        query: "",
        sectionIds: [],
        activeSection: "intro",
        selectedText: "",
        selectedSection: "",
        chatOpen: false,
        messages: [],
        busy: false,
        loggedIn: false,
        resizing: false,
        startX: 0,
        startWidth: 400
      };

      const el = {
        sidebarList: document.getElementById("sidebar-list"),
        sidebarMobileList: document.getElementById("sidebar-mobile-list"),
        sidebarSearch: document.getElementById("sidebar-search"),
        headerTitle: document.getElementById("header-title"),
        downloadBtn: document.getElementById("download-btn"),
        colabBtn: document.getElementById("colab-btn"),
        jupyterliteBtn: document.getElementById("jupyterlite-btn"),
        notebookContent: document.getElementById("notebook-content"),
        sectionSelect: document.getElementById("section-select"),
        chatLog: document.getElementById("chat-log"),
        chatInput: document.getElementById("chat-input"),
        sendChat: document.getElementById("send-chat"),
        assistantPanel: document.getElementById("assistant-panel"),
        chatFab: document.getElementById("chat-fab"),
        selectionCard: document.getElementById("selection-card"),
        selectionText: document.getElementById("selection-text"),
        clearSelection: document.getElementById("clear-selection"),
        pickSelection: document.getElementById("pick-selection"),
        loginLink: document.getElementById("login-link"),
        newChat: document.getElementById("new-chat"),
        sidebarOverlay: document.getElementById("sidebar-overlay"),
        chatOverlay: document.getElementById("chat-overlay"),
        openSidebar: document.getElementById("open-sidebar"),
        closeSidebar: document.getElementById("close-sidebar"),
        openChatMobile: document.getElementById("open-chat-mobile"),
        chatMobileMount: document.getElementById("chat-mobile-mount"),
        resizer: document.getElementById("chat-resizer")
      };

      function parseJwt(token) {
        try {
          const payload = token.split(".")[1];
          return JSON.parse(atob(payload.replace(/-/g, "+").replace(/_/g, "/")));
        } catch {
          return null;
        }
      }

      function getToken() {
        const token = localStorage.getItem(TOKEN_KEY) || "";
        if (!token) return "";
        const payload = parseJwt(token);
        if (!payload) return "";
        if (payload.exp && Date.now() >= payload.exp * 1000) {
          localStorage.removeItem(TOKEN_KEY);
          return "";
        }
        return token;
      }

      function updateAuthState() {
        const token = getToken();
        state.loggedIn = Boolean(token);

        if (state.loggedIn) {
          el.loginLink.textContent = "ログアウト";
          el.loginLink.href = "#";
          el.loginLink.onclick = function (event) {
            event.preventDefault();
            localStorage.removeItem(TOKEN_KEY);
            window.location.href = "/";
          };
          el.chatFab.classList.add("visible");
          return;
        }

        state.chatOpen = false;
        el.assistantPanel.classList.add("hidden");
        el.resizer.classList.remove("visible");
        el.chatFab.classList.remove("visible");

        el.loginLink.textContent = "ログイン";
        el.loginLink.href = "/login";
        el.loginLink.onclick = null;
      }

      function notebookList() {
        const chapters = state.catalog?.chapters || [];
        return chapters
          .slice()
          .sort((a, b) => a.order - b.order)
          .map((chapter) => ({
            ...chapter,
            notebooks: chapter.notebooks.slice().sort((a, b) => a.order - b.order)
          }));
      }

      function matchNotebook(notebook, query) {
        if (!query) return true;
        const hay = `${notebook.title} ${notebook.id} ${(notebook.tags || []).join(" ")}`.toLowerCase();
        return hay.includes(query);
      }

      function buildSidebarHtml(forMobile) {
        const query = state.query.trim().toLowerCase();
        const chapters = notebookList()
          .map((chapter) => ({ ...chapter, notebooks: chapter.notebooks.filter((nb) => matchNotebook(nb, query)) }))
          .filter((chapter) => chapter.notebooks.length > 0);

        if (!state.openChapter && chapters[0]) {
          state.openChapter = chapters[0].id;
        }

        if (chapters.length === 0) {
          return '<p style="color:var(--muted);font-size:13px;padding:8px;">一致する教材がありません。</p>';
        }

        return chapters
          .map((chapter) => {
            const expanded = chapter.id === state.openChapter;
            const items = expanded
              ? `<div class="chapter-items">${chapter.notebooks
                  .map((nb) => {
                    const active = state.activeNotebook && state.activeNotebook.id === nb.id ? "active" : "";
                    return `<button class="nb-item ${active}" data-nb-id="${nb.id}" data-mobile="${forMobile ? "1" : "0"}">${nb.title}</button>`;
                  })
                  .join("")}</div>`
              : "";

            return `
              <section class="chapter glass-soft">
                <button class="chapter-toggle" data-chapter-id="${chapter.id}" data-mobile="${forMobile ? "1" : "0"}" type="button">
                  <span>${chapter.title}</span>
                  <span>${expanded ? "−" : "+"}</span>
                </button>
                ${items}
              </section>
            `;
          })
          .join("");
      }

      function bindSidebar(container) {
        Array.from(container.querySelectorAll(".chapter-toggle")).forEach((button) => {
          button.addEventListener("click", function () {
            const id = button.getAttribute("data-chapter-id") || "";
            state.openChapter = state.openChapter === id ? "" : id;
            renderSidebar();
          });
        });

        Array.from(container.querySelectorAll(".nb-item")).forEach((button) => {
          button.addEventListener("click", function () {
            const id = button.getAttribute("data-nb-id") || "";
            if (id) {
              selectNotebook(id);
            }
            el.sidebarOverlay.classList.remove("visible");
          });
        });
      }

      function renderSidebar() {
        el.sidebarList.innerHTML = buildSidebarHtml(false);
        el.sidebarMobileList.innerHTML = buildSidebarHtml(true);
        bindSidebar(el.sidebarList);
        bindSidebar(el.sidebarMobileList);
      }

      function extractArticle(htmlText) {
        const doc = new DOMParser().parseFromString(htmlText, "text/html");
        const article = doc.querySelector("article") || doc.querySelector("main") || doc.body;
        return article ? article.innerHTML : htmlText;
      }

      function extractSectionIds(container) {
        const ids = [];
        container.querySelectorAll("h1[id], h2[id], h3[id], section[id], article[id]").forEach((node) => {
          if (node.id) ids.push(node.id);
        });
        return Array.from(new Set(ids));
      }

      function renderSections() {
        const ids = state.sectionIds.length ? state.sectionIds : ["intro"];
        el.sectionSelect.innerHTML = ids.map((id) => `<option value="${id}">${id}</option>`).join("");
        if (!ids.includes(state.activeSection)) {
          state.activeSection = ids[0];
        }
        el.sectionSelect.value = state.activeSection;
      }

      function renderHeader() {
        const nb = state.activeNotebook;
        if (!nb) return;

        el.headerTitle.textContent = nb.title;
        el.downloadBtn.href = `/notebooks/${nb.id}.ipynb`;
        el.downloadBtn.setAttribute("download", `${nb.id}.ipynb`);
        el.colabBtn.href = nb.colabUrl || "#";

        const notebookUrl = `${window.location.origin}/notebooks/${nb.id}.ipynb`;
        el.jupyterliteBtn.href = `https://jupyterlite.github.io/demo/lab/index.html?fromURL=${encodeURIComponent(notebookUrl)}`;
      }

      async function selectNotebook(notebookId) {
        const chapters = notebookList();
        let target = null;
        let chapterId = "";

        for (const chapter of chapters) {
          const found = chapter.notebooks.find((nb) => nb.id === notebookId);
          if (found) {
            target = found;
            chapterId = chapter.id;
            break;
          }
        }

        if (!target) return;

        state.activeNotebook = target;
        state.openChapter = chapterId || state.openChapter;
        state.selectedText = "";
        state.selectedSection = "";
        state.sectionIds = ["intro"];

        renderSidebar();
        renderHeader();
        renderSelectionCard();
        el.notebookContent.innerHTML = "教材を読み込み中...";

        try {
          const response = await fetch(target.htmlPath, { cache: "no-cache" });
          if (!response.ok) throw new Error("教材HTMLの読み込みに失敗しました");
          const htmlText = await response.text();
          el.notebookContent.innerHTML = extractArticle(htmlText);
          el.notebookContent.classList.add("reader-prose");
          state.sectionIds = extractSectionIds(el.notebookContent);
          state.activeSection = state.sectionIds[0] || "intro";
          renderHeader();
          renderSections();

          const url = new URL(window.location.href);
          url.searchParams.set("notebookId", target.id);
          window.history.replaceState(null, "", url.toString());
        } catch (error) {
          const msg = error instanceof Error ? error.message : "読み込みエラー";
          el.notebookContent.innerHTML = `<p style=\"color:#b5003c\">${msg}</p>`;
        }
      }

      function captureSelection() {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return null;

        const text = selection.toString().trim();
        if (!text) return null;

        const range = selection.getRangeAt(0);
        if (!el.notebookContent.contains(range.startContainer) || !el.notebookContent.contains(range.endContainer)) {
          return null;
        }

        let node = range.startContainer.nodeType === Node.ELEMENT_NODE ? range.startContainer : range.startContainer.parentElement;
        while (node && node !== el.notebookContent) {
          if (node.id) {
            return { text, sectionId: node.id };
          }
          node = node.parentElement;
        }

        return { text, sectionId: "" };
      }

      function renderSelectionCard() {
        if (!state.selectedText) {
          el.selectionCard.style.display = "none";
          el.selectionText.textContent = "";
          return;
        }

        el.selectionCard.style.display = "flex";
        el.selectionText.textContent = state.selectedText;
      }

      function pushMessage(role, text, meta) {
        state.messages.push({ role, text, meta: meta || {} });
        renderMessages();
      }

      function renderMessages() {
        if (!state.messages.length) {
          el.chatLog.innerHTML = '<p style="color:var(--muted);font-size:13px;">質問を入力して送信してください。</p>';
          return;
        }

        el.chatLog.innerHTML = state.messages
          .map((message) => {
            const refs = message.meta && message.meta.refs ? `<div class=\"msg-meta\">参照: ${message.meta.refs}</div>` : "";
            return `<article class=\"msg ${message.role}\">${escapeHtml(message.text)}${refs}</article>`;
          })
          .join("");
        el.chatLog.scrollTop = el.chatLog.scrollHeight;
      }

      function escapeHtml(value) {
        return value
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;")
          .replace(/\n/g, "<br>");
      }

      async function pollAnswer(questionId, token) {
        for (let i = 0; i < 25; i += 1) {
          const response = await fetch(`${API_BASE}/api/questions/${encodeURIComponent(questionId)}/answer`, {
            headers: { Authorization: `Bearer ${token}` }
          });

          if (response.status === 202) {
            await new Promise((resolve) => setTimeout(resolve, 1200));
            continue;
          }

          if (!response.ok) {
            let error = "回答の取得に失敗しました";
            try {
              const payload = await response.json();
              if (payload && payload.error) error = payload.error;
            } catch {}
            throw new Error(error);
          }

          return response.json();
        }

        throw new Error("回答待機がタイムアウトしました");
      }

      async function sendQuestion() {
        if (state.busy || !state.loggedIn) return;

        const text = el.chatInput.value.trim();
        if (!text) return;

        const notebook = state.activeNotebook;
        if (!notebook) return;

        const token = getToken();
        if (!token) {
          pushMessage("system", "セッションが切れています。再ログインしてください。");
          setChatOpen(false);
          updateAuthState();
          return;
        }

        const selection = captureSelection();
        if (selection) {
          state.selectedText = selection.text;
          state.selectedSection = selection.sectionId || "";
          renderSelectionCard();
        }

        const sectionId = state.selectedSection || state.activeSection || "intro";
        const questionText = state.selectedText ? `${text}\n\n[Selection]\n${state.selectedText}` : text;

        pushMessage("user", text);
        el.chatInput.value = "";
        state.busy = true;
        el.sendChat.disabled = true;
        el.sendChat.textContent = "回答生成中...";

        try {
          const response = await fetch(`${API_BASE}/api/questions`, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({
              notebookId: notebook.id,
              sectionId,
              questionText
            })
          });

          if (!response.ok) {
            let error = "質問の送信に失敗しました";
            try {
              const payload = await response.json();
              if (payload && payload.error) error = payload.error;
            } catch {}
            throw new Error(error);
          }

          const payload = await response.json();
          const answer = await pollAnswer(payload.questionId, token);
          const refs = (answer.sourceReferences || []).map((source) => `${source.notebookId}${source.location}`).join(", ");
          pushMessage("assistant", answer.answerText || "回答が空でした", { refs });
        } catch (error) {
          pushMessage("system", error instanceof Error ? error.message : "質問処理に失敗しました");
        } finally {
          state.busy = false;
          el.sendChat.disabled = false;
          el.sendChat.textContent = "送信";
        }
      }

      function setChatOpen(open) {
        if (open && !state.loggedIn) {
          window.location.href = "/login";
          return;
        }

        state.chatOpen = open;
        el.assistantPanel.classList.toggle("hidden", !open);
        el.resizer.classList.toggle("visible", open && window.innerWidth > 960);
        el.chatFab.classList.toggle("visible", !open && state.loggedIn);
      }

      function startResize(event) {
        if (window.innerWidth <= 960 || !state.chatOpen) return;
        state.resizing = true;
        state.startX = event.clientX;
        state.startWidth = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--assistant-width")) || 400;
        document.body.style.userSelect = "none";
      }

      function onResize(event) {
        if (!state.resizing) return;
        const diff = state.startX - event.clientX;
        const next = Math.max(320, Math.min(700, state.startWidth + diff));
        document.documentElement.style.setProperty("--assistant-width", `${next}px`);
      }

      function stopResize() {
        if (!state.resizing) return;
        state.resizing = false;
        document.body.style.userSelect = "";
      }

      async function loadCatalog() {
        const response = await fetch("/catalog.json", { cache: "no-cache" });
        if (!response.ok) {
          throw new Error("catalog.json の読み込みに失敗しました");
        }
        return response.json();
      }

      function findInitialNotebookId() {
        const q = new URLSearchParams(window.location.search);
        return q.get("notebookId") || "";
      }

      async function init() {
        updateAuthState();
        renderMessages();

        try {
          state.catalog = await loadCatalog();
        } catch (error) {
          el.notebookContent.innerHTML = `<p style=\"color:#b5003c\">${error instanceof Error ? error.message : "初期化エラー"}</p>`;
          return;
        }

        const chapters = notebookList();
        const notebooks = chapters.flatMap((chapter) => chapter.notebooks);
        if (!notebooks.length) {
          el.notebookContent.innerHTML = "教材がありません。";
          return;
        }

        const requested = findInitialNotebookId();
        const first = notebooks.find((nb) => nb.id === requested) || notebooks[0];

        state.openChapter = chapters.find((ch) => ch.notebooks.some((nb) => nb.id === first.id))?.id || chapters[0]?.id || "";
        renderSidebar();
        await selectNotebook(first.id);
      }

      el.sidebarSearch.addEventListener("input", function (event) {
        state.query = event.target.value || "";
        renderSidebar();
      });

      el.sectionSelect.addEventListener("change", function () {
        state.activeSection = el.sectionSelect.value;
      });

      el.sendChat.addEventListener("click", function () {
        void sendQuestion();
      });

      el.chatInput.addEventListener("keydown", function (event) {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          event.preventDefault();
          void sendQuestion();
        }
      });

      el.pickSelection.addEventListener("click", function () {
        const selection = captureSelection();
        if (!selection) {
          pushMessage("system", "まずノート本文中のテキストを選択してください。");
          return;
        }
        state.selectedText = selection.text;
        state.selectedSection = selection.sectionId || "";
        renderSelectionCard();
      });

      el.clearSelection.addEventListener("click", function () {
        state.selectedText = "";
        state.selectedSection = "";
        renderSelectionCard();
      });

      el.newChat.addEventListener("click", function () {
        state.messages = [];
        renderMessages();
      });

      el.chatFab.addEventListener("click", function () {
        setChatOpen(true);
      });

      el.openSidebar.addEventListener("click", function () {
        el.sidebarOverlay.classList.add("visible");
      });

      el.closeSidebar.addEventListener("click", function () {
        el.sidebarOverlay.classList.remove("visible");
      });

      el.openChatMobile.addEventListener("click", function () {
        if (!state.loggedIn) {
          window.location.href = "/login";
          return;
        }
        setChatOpen(true);
        el.chatOverlay.classList.add("visible");
        el.chatMobileMount.innerHTML = "";
        el.chatMobileMount.appendChild(el.assistantPanel);
        el.assistantPanel.style.display = "flex";
      });

      el.sidebarOverlay.addEventListener("click", function (event) {
        if (event.target === el.sidebarOverlay) {
          el.sidebarOverlay.classList.remove("visible");
        }
      });

      el.chatOverlay.addEventListener("click", function (event) {
        if (event.target === el.chatOverlay) {
          el.chatOverlay.classList.remove("visible");
          if (window.innerWidth <= 960) {
            document.getElementById("shell").appendChild(el.assistantPanel);
          }
        }
      });

      el.resizer.addEventListener("mousedown", startResize);
      window.addEventListener("mousemove", onResize);
      window.addEventListener("mouseup", stopResize);
      window.addEventListener("mouseleave", stopResize);

      window.addEventListener("resize", function () {
        if (window.innerWidth <= 960) {
          el.resizer.classList.remove("visible");
        } else if (state.chatOpen) {
          el.resizer.classList.add("visible");
          if (el.assistantPanel.parentElement !== document.getElementById("shell")) {
            document.getElementById("shell").appendChild(el.assistantPanel);
          }
          el.chatOverlay.classList.remove("visible");
        }
      });

      void init();
    })();
  </script>
</body>
</html>
