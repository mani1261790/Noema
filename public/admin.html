<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noema Admin</title>
  <style>
    :root {
      --bg-0: #061020;
      --bg-1: #10243b;
      --bg-2: #1a2f44;
      --text: #ebf3ff;
      --muted: #a7bdd9;
      --panel: rgba(12, 22, 39, .78);
      --panel-soft: rgba(14, 28, 46, .54);
      --border: rgba(145, 183, 227, .3);
      --accent: #78aebf;
      --accent-strong: #5f95a7;
      --danger: #d08a9a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      background:
        radial-gradient(circle at 12% 10%, rgba(120, 174, 191, .18), transparent 42%),
        radial-gradient(circle at 90% 7%, rgba(255, 154, 95, .15), transparent 36%),
        radial-gradient(circle at 76% 82%, rgba(112, 183, 255, .16), transparent 40%),
        linear-gradient(158deg, var(--bg-0) 0%, var(--bg-1) 50%, var(--bg-2) 100%);
      padding: 14px;
    }

    .shell {
      max-width: 1500px;
      margin: 0 auto;
      border-radius: 26px;
      border: 1px solid var(--border);
      background: var(--panel);
      backdrop-filter: blur(22px) saturate(145%);
      -webkit-backdrop-filter: blur(22px) saturate(145%);
      box-shadow: 0 32px 72px rgba(3, 9, 22, .52), inset 0 1px 0 rgba(170, 210, 255, .18);
      padding: 12px;
    }

    .topbar {
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--panel-soft);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .back {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .52);
      color: var(--text);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 18px;
      line-height: 1;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta {
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    .button, .button-ghost, .button-danger {
      border-radius: 10px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      text-decoration: none;
    }

    .button {
      border: 1px solid color-mix(in oklab, var(--accent) 52%, white);
      color: #fff;
      background: linear-gradient(145deg, var(--accent) 0%, var(--accent-strong) 100%);
      box-shadow: 0 8px 16px color-mix(in oklab, var(--accent) 20%, transparent);
    }

    .button-ghost {
      border: 1px solid var(--border);
      background: rgba(17, 34, 54, .5);
      color: var(--text);
    }

    .button-danger {
      border: 1px solid color-mix(in oklab, var(--danger) 52%, white);
      color: #fff3f6;
      background: linear-gradient(
        145deg,
        color-mix(in oklab, var(--danger) 46%, transparent),
        color-mix(in oklab, var(--danger) 28%, #2c1b24)
      );
      box-shadow: 0 8px 16px color-mix(in oklab, var(--danger) 18%, transparent);
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(320px, 420px) minmax(0, 1fr);
      gap: 10px;
      min-height: calc(100dvh - 96px);
    }

    .panel {
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--panel-soft);
      padding: 12px;
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel h2 {
      margin: 0;
      font-size: 16px;
    }

    .form-grid {
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr 1fr;
    }

    .form-grid .full { grid-column: 1 / -1; }

    label {
      display: grid;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    input {
      border: 1px solid var(--border);
      background: rgba(16, 32, 52, .62);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      outline: none;
      width: 100%;
    }

    input:focus {
      border-color: color-mix(in oklab, var(--accent) 70%, white);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 24%, transparent);
    }

    .status {
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 0;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity 140ms ease, transform 140ms ease, max-height 160ms ease, padding 140ms ease;
      line-height: 1.55;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .status[data-visible="true"] {
      opacity: 1;
      transform: translateY(0);
      max-height: 220px;
      padding: 10px 12px;
    }

    .status[data-kind="info"] {
      background: rgba(20, 40, 64, .56);
      border-color: color-mix(in oklab, var(--accent) 34%, var(--border));
      color: #d9efff;
    }

    .status[data-kind="success"] {
      border-color: rgba(96, 214, 180, .52);
      background: rgba(16, 52, 45, .58);
      color: #d6ffef;
    }

    .status[data-kind="error"] {
      border-color: rgba(245, 122, 138, .64);
      background: rgba(69, 22, 35, .6);
      color: #ffdbe2;
    }

    .list-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .head-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .chapters {
      min-height: 0;
      overflow: auto;
      display: grid;
      gap: 10px;
      padding-right: 2px;
      align-content: start;
    }

    .chapter-card {
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(16, 32, 52, .52);
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .chapter-head {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto auto;
      gap: 8px;
      align-items: center;
    }

    .chapter-title-input {
      font-weight: 600;
    }

    .dropzone {
      min-height: 68px;
      border: 1px dashed color-mix(in oklab, var(--border) 85%, transparent);
      border-radius: 12px;
      padding: 8px;
      display: grid;
      gap: 8px;
      background: rgba(7, 17, 30, .2);
    }

    .dropzone.is-over {
      border-color: color-mix(in oklab, var(--accent) 68%, white);
      background: rgba(22, 49, 76, .34);
    }

    .empty-drop {
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      padding: 8px 4px;
    }

    .nb-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(14, 29, 47, .76);
      padding: 9px;
      display: grid;
      gap: 8px;
      cursor: grab;
    }

    .nb-card.dragging {
      opacity: .45;
    }

    .nb-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: var(--muted);
      font-size: 11px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
    }

    .drag-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      color: var(--muted);
      background: rgba(18, 35, 56, .56);
    }

    .nb-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .nb-grid .full { grid-column: 1 / -1; }

    .nb-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .empty {
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
    }

    @media (max-width: 1180px) {
      .main-grid { grid-template-columns: 1fr; min-height: auto; }
      .form-grid, .nb-grid { grid-template-columns: 1fr; }
      .chapter-head { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="shell">
    <header class="topbar">
      <div class="left">
        <a class="back" href="/" aria-label="トップへ戻る">‹</a>
        <div>
          <h1>Noema Admin</h1>
          <div class="meta">教材（ipynb）管理: セクション編集 / 並び替え / 追加 / 削除</div>
        </div>
      </div>
      <button class="button-ghost" id="logout-btn" type="button">ログアウト</button>
    </header>

    <div class="main-grid">
      <section class="panel">
        <h2>教材を追加</h2>
        <form id="upload-form" class="form-grid">
          <label>タイトル
            <input name="title" required />
          </label>
          <label>章タイトル
            <input name="chapter" required />
          </label>
          <label>順序
            <input name="order" type="number" min="1" value="1" required />
          </label>
          <label>タグ（カンマ区切り）
            <input name="tags" />
          </label>
          <label class="full">Colab URL
            <input name="colabUrl" required />
          </label>
          <label class="full">動画 URL（任意）
            <input name="videoUrl" />
          </label>
          <label class="full">ipynb ファイル
            <input name="file" type="file" accept=".ipynb,application/json" required />
          </label>
          <button class="button full" id="upload-btn" type="submit">ipynb を登録</button>
        </form>
        <div class="status" id="upload-status" data-visible="false" data-kind="info"></div>
      </section>

      <section class="panel">
        <div class="list-head">
          <h2>教材一覧</h2>
          <div class="head-actions">
            <span class="meta" id="count-label">0 sections / 0 notebooks</span>
            <button class="button-ghost" id="add-section-btn" type="button">セクション追加</button>
            <button class="button" id="save-layout-btn" type="button">並び順・セクション保存</button>
            <button class="button-ghost" id="refresh-btn" type="button">再読込</button>
          </div>
        </div>
        <div class="meta">ドラッグ&ドロップでノートを並び替え/セクション移動できます。空セクションはノートを入れて保存したときのみ永続反映されます。</div>
        <div class="status" id="list-status" data-visible="false" data-kind="info"></div>
        <div class="chapters" id="chapters"></div>
      </section>
    </div>
  </main>

  <script>
    (function () {
      const API_BASE = "https://52d3l83li2.execute-api.ap-northeast-3.amazonaws.com";
      const TOKEN_KEY = "noema_id_token";

      const uploadStatusEl = document.getElementById("upload-status");
      const listStatusEl = document.getElementById("list-status");
      const uploadForm = document.getElementById("upload-form");
      const uploadBtn = document.getElementById("upload-btn");
      const refreshBtn = document.getElementById("refresh-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const countLabelEl = document.getElementById("count-label");
      const addSectionBtn = document.getElementById("add-section-btn");
      const saveLayoutBtn = document.getElementById("save-layout-btn");
      const chaptersEl = document.getElementById("chapters");

      const state = {
        sections: [],
        notebooksById: {},
        draggingNotebookId: "",
        dirtyLayout: false
      };

      function uid(prefix) {
        return `${prefix}-${Math.random().toString(36).slice(2, 10)}`;
      }

      function setStatus(target, kind, message) {
        if (!message) {
          target.dataset.visible = "false";
          target.dataset.kind = "info";
          target.textContent = "";
          return;
        }
        target.dataset.visible = "true";
        target.dataset.kind = kind;
        target.textContent = message;
      }

      function parseJwt(token) {
        try {
          const payload = token.split(".")[1];
          return JSON.parse(atob(payload.replace(/-/g, "+").replace(/_/g, "/")));
        } catch {
          return null;
        }
      }

      function getToken() {
        const token = localStorage.getItem(TOKEN_KEY) || "";
        if (!token) return "";
        const payload = parseJwt(token);
        if (!payload) return "";
        if (payload.exp && Date.now() >= payload.exp * 1000) {
          localStorage.removeItem(TOKEN_KEY);
          return "";
        }
        return token;
      }

      function requireLogin() {
        const token = getToken();
        if (token) return token;
        window.location.href = "/login";
        throw new Error("ログインが必要です。");
      }

      function escapeHtml(value) {
        return String(value || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      async function api(path, init) {
        const token = requireLogin();
        let response;
        try {
          response = await fetch(`${API_BASE}${path}`, {
            ...init,
            headers: {
              ...(init && init.headers ? init.headers : {}),
              Authorization: `Bearer ${token}`
            }
          });
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          throw new Error(`APIに接続できませんでした: ${message}`);
        }

        let payload = {};
        let rawText = "";
        try {
          rawText = await response.text();
          payload = rawText ? JSON.parse(rawText) : {};
        } catch {
          payload = rawText ? { error: rawText } : {};
        }

        if (!response.ok) {
          const errorText = payload && payload.error ? String(payload.error) : `Request failed (${response.status})`;
          if (response.status === 401) {
            localStorage.removeItem(TOKEN_KEY);
            window.location.href = "/login";
          }
          if (response.status === 403) {
            const tokenPayload = parseJwt(token) || {};
            const identity =
              String(tokenPayload.email || tokenPayload["cognito:username"] || tokenPayload.username || "").trim() || "不明";
            throw new Error(
              `管理者権限が必要です（現在ログイン: ${identity}）。Deploy Infra の admin_emails にこのメールを設定してください。`
            );
          }
          throw new Error(errorText);
        }

        return payload;
      }

      function markDirty(flag) {
        state.dirtyLayout = Boolean(flag);
        saveLayoutBtn.textContent = state.dirtyLayout ? "並び順・セクション保存 *" : "並び順・セクション保存";
      }

      function buildStateFromItems(items) {
        state.notebooksById = {};
        state.sections = [];

        const sectionMap = new Map();

        (items || []).forEach((item) => {
          const sectionTitle = String(item.chapter || "未分類").trim() || "未分類";
          let section = sectionMap.get(sectionTitle);
          if (!section) {
            section = { id: uid("section"), title: sectionTitle, notebookIds: [] };
            sectionMap.set(sectionTitle, section);
            state.sections.push(section);
          }

          const notebook = {
            notebookId: String(item.notebookId || "").trim(),
            title: String(item.title || ""),
            tags: Array.isArray(item.tags) ? item.tags.map((v) => String(v).trim()).filter(Boolean) : [],
            colabUrl: String(item.colabUrl || ""),
            videoUrl: String(item.videoUrl || ""),
            htmlPath: String(item.htmlPath || ""),
            sortOrder: Number(item.sortOrder || 1)
          };

          if (!notebook.notebookId) return;
          state.notebooksById[notebook.notebookId] = notebook;
          section.notebookIds.push(notebook.notebookId);
        });

        state.sections.forEach((section) => {
          section.notebookIds.sort((a, b) => {
            const aa = state.notebooksById[a];
            const bb = state.notebooksById[b];
            return (aa?.sortOrder || 1) - (bb?.sortOrder || 1);
          });
        });

        markDirty(false);
      }

      function sectionById(sectionId) {
        return state.sections.find((section) => section.id === sectionId) || null;
      }

      function notebookById(notebookId) {
        return state.notebooksById[notebookId] || null;
      }

      function removeNotebookFromSections(notebookId) {
        state.sections.forEach((section) => {
          section.notebookIds = section.notebookIds.filter((id) => id !== notebookId);
        });
      }

      function updateCounts() {
        const notebookCount = Object.keys(state.notebooksById).length;
        countLabelEl.textContent = `${state.sections.length} sections / ${notebookCount} notebooks`;
      }

      function cardTemplate(notebookId, sectionId, indexInSection) {
        const nb = notebookById(notebookId);
        if (!nb) return "";

        return `
          <article class="nb-card" draggable="true" data-notebook-id="${escapeHtml(nb.notebookId)}" data-section-id="${escapeHtml(sectionId)}">
            <div class="nb-head">
              <span>${escapeHtml(nb.notebookId)}</span>
              <span class="drag-chip">drag</span>
            </div>
            <div class="nb-grid">
              <label>タイトル
                <input data-field="title" value="${escapeHtml(nb.title)}" />
              </label>
              <label>タグ（カンマ区切り）
                <input data-field="tags" value="${escapeHtml((nb.tags || []).join(", "))}" />
              </label>
              <label class="full">Colab URL
                <input data-field="colabUrl" value="${escapeHtml(nb.colabUrl || "")}" />
              </label>
              <label class="full">動画 URL
                <input data-field="videoUrl" value="${escapeHtml(nb.videoUrl || "")}" />
              </label>
              <div class="meta full">順序: ${indexInSection + 1} / HTML: ${escapeHtml(nb.htmlPath || "")}</div>
            </div>
            <div class="nb-actions">
              <button class="button-ghost" data-action="save-notebook" type="button">保存</button>
              <button class="button-danger" data-action="delete-notebook" type="button">削除</button>
            </div>
          </article>
        `;
      }

      function chapterTemplate(section) {
        const cards = section.notebookIds
          .map((notebookId, index) => cardTemplate(notebookId, section.id, index))
          .join("");

        return `
          <section class="chapter-card" data-section-id="${escapeHtml(section.id)}">
            <div class="chapter-head">
              <input class="chapter-title-input" data-role="section-title" value="${escapeHtml(section.title)}" />
              <button class="button-ghost" data-action="rename-section" type="button">名称反映</button>
              <button class="button-danger" data-action="delete-section" type="button">セクション削除</button>
            </div>
            <div class="dropzone" data-role="dropzone" data-section-id="${escapeHtml(section.id)}">
              ${cards || '<div class="empty-drop">ここにノートをドロップ</div>'}
            </div>
          </section>
        `;
      }

      function renderChapters() {
        updateCounts();

        if (state.sections.length === 0) {
          chaptersEl.innerHTML = '<div class="empty">教材がありません。左のフォームから ipynb を登録してください。</div>';
          return;
        }

        chaptersEl.innerHTML = state.sections.map(chapterTemplate).join("");
        bindEventsAfterRender();
      }

      function sectionTitleOfCard(cardElement) {
        const sectionElement = cardElement.closest("[data-section-id]");
        if (!sectionElement) return "未分類";
        const input = sectionElement.querySelector("[data-role='section-title']");
        return String(input ? input.value : "未分類").trim() || "未分類";
      }

      function notebookPayloadFromCard(cardElement) {
        const notebookId = cardElement.getAttribute("data-notebook-id") || "";
        const sectionId = cardElement.getAttribute("data-section-id") || "";
        const section = sectionById(sectionId);
        const sectionTitle = section ? section.title.trim() : sectionTitleOfCard(cardElement);

        const title = String(cardElement.querySelector("[data-field='title']")?.value || "").trim();
        const colabUrl = String(cardElement.querySelector("[data-field='colabUrl']")?.value || "").trim();
        const videoUrl = String(cardElement.querySelector("[data-field='videoUrl']")?.value || "").trim();
        const tags = String(cardElement.querySelector("[data-field='tags']")?.value || "")
          .split(",")
          .map((value) => value.trim())
          .filter(Boolean);

        const sectionCards = Array.from(cardElement.parentElement?.querySelectorAll(".nb-card") || []);
        const sortOrder = sectionCards.findIndex((node) => node === cardElement) + 1;

        return {
          notebookId,
          title,
          chapter: sectionTitle,
          sortOrder: sortOrder > 0 ? sortOrder : 1,
          tags,
          colabUrl,
          videoUrl
        };
      }

      function persistCardValuesToState(cardElement) {
        const payload = notebookPayloadFromCard(cardElement);
        const nb = notebookById(payload.notebookId);
        if (!nb) return;

        nb.title = payload.title;
        nb.tags = payload.tags;
        nb.colabUrl = payload.colabUrl;
        nb.videoUrl = payload.videoUrl;
      }

      function getDropIndex(dropzone, y) {
        const cards = Array.from(dropzone.querySelectorAll(".nb-card:not(.dragging)"));
        for (let i = 0; i < cards.length; i += 1) {
          const rect = cards[i].getBoundingClientRect();
          if (y < rect.top + rect.height / 2) {
            return i;
          }
        }
        return cards.length;
      }

      function moveNotebook(notebookId, targetSectionId, targetIndex) {
        if (!notebookId || !targetSectionId) return;

        const target = sectionById(targetSectionId);
        if (!target) return;

        let currentSection = null;
        state.sections.forEach((section) => {
          if (section.notebookIds.includes(notebookId)) {
            currentSection = section;
          }
        });
        if (!currentSection) return;

        currentSection.notebookIds = currentSection.notebookIds.filter((id) => id !== notebookId);

        const clamped = Math.max(0, Math.min(targetIndex, target.notebookIds.length));
        target.notebookIds.splice(clamped, 0, notebookId);

        markDirty(true);
        renderChapters();
      }

      async function saveSingleNotebook(cardElement, button) {
        const payload = notebookPayloadFromCard(cardElement);
        if (!payload.notebookId || !payload.title || !payload.chapter || !payload.colabUrl) {
          setStatus(listStatusEl, "error", "タイトル / セクション名 / Colab URL は必須です。");
          return;
        }

        button.disabled = true;
        setStatus(listStatusEl, "info", `保存中... (${payload.notebookId})`);

        try {
          await api("/api/admin/notebooks", {
            method: "PATCH",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload)
          });
          persistCardValuesToState(cardElement);
          const section = sectionById(cardElement.getAttribute("data-section-id") || "");
          if (section) {
            section.title = payload.chapter;
          }
          setStatus(listStatusEl, "success", `保存しました: ${payload.notebookId}`);
        } catch (error) {
          setStatus(listStatusEl, "error", error instanceof Error ? error.message : String(error));
        } finally {
          button.disabled = false;
          renderChapters();
        }
      }

      async function deleteNotebook(notebookId, button) {
        if (!notebookId) return;
        const ok = window.confirm(`教材 ${notebookId} を削除します。元に戻せません。`);
        if (!ok) return;

        button.disabled = true;
        setStatus(listStatusEl, "info", `削除中... (${notebookId})`);

        try {
          await api(`/api/admin/notebooks/${encodeURIComponent(notebookId)}`, {
            method: "DELETE"
          });

          removeNotebookFromSections(notebookId);
          delete state.notebooksById[notebookId];
          state.sections = state.sections.filter((section) => section.notebookIds.length > 0 || section.title.trim());
          setStatus(listStatusEl, "success", `削除しました: ${notebookId}`);
          renderChapters();
        } catch (error) {
          setStatus(listStatusEl, "error", error instanceof Error ? error.message : String(error));
        } finally {
          button.disabled = false;
        }
      }

      async function deleteSection(sectionId, button) {
        const section = sectionById(sectionId);
        if (!section) return;

        if (section.notebookIds.length === 0) {
          state.sections = state.sections.filter((item) => item.id !== sectionId);
          setStatus(listStatusEl, "success", `空セクションを削除しました: ${section.title || "(無題)"}`);
          markDirty(true);
          renderChapters();
          return;
        }

        const ok = window.confirm(
          `セクション「${section.title}」配下の ${section.notebookIds.length} 件をすべて削除します。元に戻せません。`
        );
        if (!ok) return;

        button.disabled = true;
        setStatus(listStatusEl, "info", `セクション削除中... (${section.title})`);

        try {
          for (const notebookId of section.notebookIds) {
            await api(`/api/admin/notebooks/${encodeURIComponent(notebookId)}`, { method: "DELETE" });
            delete state.notebooksById[notebookId];
          }
          state.sections = state.sections.filter((item) => item.id !== sectionId);
          setStatus(listStatusEl, "success", `セクションを削除しました: ${section.title}`);
          renderChapters();
        } catch (error) {
          setStatus(listStatusEl, "error", error instanceof Error ? error.message : String(error));
        } finally {
          button.disabled = false;
        }
      }

      async function saveLayout() {
        const allNotebooks = Object.keys(state.notebooksById);
        if (!allNotebooks.length) {
          setStatus(listStatusEl, "info", "保存対象のノートがありません。");
          return;
        }

        for (const section of state.sections) {
          if (section.notebookIds.length > 0 && !section.title.trim()) {
            setStatus(listStatusEl, "error", "ノートを含むセクションの名前は空にできません。");
            return;
          }
        }

        setStatus(listStatusEl, "info", "並び順とセクションを保存中...");
        saveLayoutBtn.disabled = true;

        try {
          for (const section of state.sections) {
            const chapter = section.title.trim() || "未分類";
            for (let i = 0; i < section.notebookIds.length; i += 1) {
              const notebookId = section.notebookIds[i];
              const notebook = notebookById(notebookId);
              if (!notebook) continue;

              await api("/api/admin/notebooks", {
                method: "PATCH",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({
                  notebookId,
                  title: notebook.title,
                  tags: notebook.tags,
                  colabUrl: notebook.colabUrl,
                  videoUrl: notebook.videoUrl,
                  chapter,
                  sortOrder: i + 1
                })
              });

              notebook.sortOrder = i + 1;
            }
          }

          markDirty(false);
          setStatus(listStatusEl, "success", "並び順とセクションを保存しました。");
          await loadNotebooks();
        } catch (error) {
          setStatus(listStatusEl, "error", error instanceof Error ? error.message : String(error));
        } finally {
          saveLayoutBtn.disabled = false;
        }
      }

      function bindEventsAfterRender() {
        chaptersEl.querySelectorAll("[data-role='section-title']").forEach((input) => {
          input.addEventListener("input", function () {
            const sectionElement = input.closest("[data-section-id]");
            if (!sectionElement) return;
            const sectionId = sectionElement.getAttribute("data-section-id") || "";
            const section = sectionById(sectionId);
            if (!section) return;
            section.title = String(input.value || "");
            markDirty(true);
          });
        });

        chaptersEl.querySelectorAll("[data-action='rename-section']").forEach((button) => {
          button.addEventListener("click", function () {
            const sectionElement = button.closest("[data-section-id]");
            if (!sectionElement) return;
            const sectionId = sectionElement.getAttribute("data-section-id") || "";
            const section = sectionById(sectionId);
            if (!section) return;
            section.title = String(sectionElement.querySelector("[data-role='section-title']")?.value || "").trim();
            if (!section.title) {
              setStatus(listStatusEl, "error", "セクション名を入力してください。");
              return;
            }
            setStatus(listStatusEl, "success", `セクション名を変更しました。保存ボタンで反映してください: ${section.title}`);
            markDirty(true);
            renderChapters();
          });
        });

        chaptersEl.querySelectorAll("[data-action='delete-section']").forEach((button) => {
          button.addEventListener("click", function () {
            const sectionElement = button.closest("[data-section-id]");
            if (!sectionElement) return;
            const sectionId = sectionElement.getAttribute("data-section-id") || "";
            void deleteSection(sectionId, button);
          });
        });

        chaptersEl.querySelectorAll(".nb-card").forEach((card) => {
          card.addEventListener("dragstart", function (event) {
            state.draggingNotebookId = card.getAttribute("data-notebook-id") || "";
            card.classList.add("dragging");
            if (event.dataTransfer) {
              event.dataTransfer.effectAllowed = "move";
              event.dataTransfer.setData("text/plain", state.draggingNotebookId);
            }
          });

          card.addEventListener("dragend", function () {
            card.classList.remove("dragging");
            state.draggingNotebookId = "";
            chaptersEl.querySelectorAll(".dropzone").forEach((zone) => zone.classList.remove("is-over"));
          });

          card.querySelectorAll("[data-field]").forEach((input) => {
            input.addEventListener("input", function () {
              persistCardValuesToState(card);
              markDirty(true);
            });
          });

          card.querySelector("[data-action='save-notebook']")?.addEventListener("click", function () {
            void saveSingleNotebook(card, this);
          });

          card.querySelector("[data-action='delete-notebook']")?.addEventListener("click", function () {
            const notebookId = card.getAttribute("data-notebook-id") || "";
            void deleteNotebook(notebookId, this);
          });
        });

        chaptersEl.querySelectorAll(".dropzone").forEach((dropzone) => {
          dropzone.addEventListener("dragover", function (event) {
            event.preventDefault();
            dropzone.classList.add("is-over");
          });

          dropzone.addEventListener("dragleave", function () {
            dropzone.classList.remove("is-over");
          });

          dropzone.addEventListener("drop", function (event) {
            event.preventDefault();
            dropzone.classList.remove("is-over");

            const notebookId = state.draggingNotebookId || (event.dataTransfer ? event.dataTransfer.getData("text/plain") : "");
            if (!notebookId) return;

            const sectionId = dropzone.getAttribute("data-section-id") || "";
            const dropIndex = getDropIndex(dropzone, event.clientY);
            moveNotebook(notebookId, sectionId, dropIndex);
          });
        });
      }

      async function loadNotebooks() {
        setStatus(listStatusEl, "info", "教材一覧を読み込み中...");
        try {
          const payload = await api("/api/admin/notebooks", { method: "GET" });
          const items = Array.isArray(payload.items) ? payload.items : [];
          buildStateFromItems(items);
          renderChapters();
          setStatus(listStatusEl, "success", "教材一覧を更新しました。");
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          chaptersEl.innerHTML = `<div class="empty">教材一覧の取得に失敗しました。<br />${escapeHtml(message)}</div>`;
          setStatus(listStatusEl, "error", message);
          markDirty(false);
          updateCounts();
        }
      }

      uploadForm.addEventListener("submit", async function (event) {
        event.preventDefault();
        setStatus(uploadStatusEl, "info", "登録中です...");
        uploadBtn.disabled = true;

        try {
          const formData = new FormData(uploadForm);
          const title = String(formData.get("title") || "").trim();
          const chapter = String(formData.get("chapter") || "").trim();
          const colabUrl = String(formData.get("colabUrl") || "").trim();
          const file = formData.get("file");

          if (!title || !chapter || !colabUrl || !(file instanceof File)) {
            throw new Error("タイトル / 章 / Colab URL / ipynb は必須です。");
          }

          const response = await api("/api/admin/notebooks", {
            method: "POST",
            body: formData
          });

          setStatus(uploadStatusEl, "success", `登録完了: ${response.notebookId || title}`);
          uploadForm.reset();
          await loadNotebooks();
        } catch (error) {
          setStatus(uploadStatusEl, "error", error instanceof Error ? error.message : String(error));
        } finally {
          uploadBtn.disabled = false;
        }
      });

      addSectionBtn.addEventListener("click", function () {
        state.sections.push({
          id: uid("section"),
          title: "新しいセクション",
          notebookIds: []
        });
        markDirty(true);
        renderChapters();
        setStatus(listStatusEl, "info", "セクションを追加しました。ノートを移動して保存すると反映されます。");
      });

      saveLayoutBtn.addEventListener("click", function () {
        void saveLayout();
      });

      refreshBtn.addEventListener("click", function () {
        void loadNotebooks();
      });

      logoutBtn.addEventListener("click", function () {
        localStorage.removeItem(TOKEN_KEY);
        window.location.href = "/login";
      });

      requireLogin();
      void loadNotebooks();
    })();
  </script>
</body>
</html>
